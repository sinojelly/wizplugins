jQuery.fn.extend({sheet:function(a){a=a||{};jQuery(this).each(function(){var j=Globalize,f=jQuery(this),h={editable:true,editableNames:true,barMenus:true,freezableCells:true,allowToggleState:true,menuLeft:null,newColumnWidth:120,title:null,menuRight:null,calcOff:false,log:false,lockFormulas:false,parent:f,colMargin:18,boxModelCorrection:2,formulaFunctions:{},formulaVariables:{},cellSelectModel:"excel",autoAddCells:true,resizableCells:true,resizableSheet:true,autoFiller:true,minSize:{rows:1,cols:1},alertFormulaErrors:false,error:function(k){return k.error;},endOfNumber:false,encode:function(m){if(!this.endOfNumber){var l=j.culture().numberFormat["."];this.endOfNumber=new RegExp("(["+(l=="."?".":l)+"])([0-9]*?[1-9]+)?(0)*$");}switch(typeof m){case"object":return m;case"number":return j.format(m,"n10").replace(this.endOfNumber,function(p,o,n){return(n?o:"")+(n||"");});}if(!m){return m||"";}if(!m.replace){return m||"";}var k=$.trim(m)*1;if(!isNaN(k)){return j.format(k,"n10").replace(this.endOfNumber,function(p,o,n){return(n?o:"")+(n||"");});}return m.replace(/&/gi,"&amp;").replace(/>/gi,"&gt;").replace(/</gi,"&lt;").replace(/\n/g,"\n<br>").replace(/\t/g,"&nbsp;&nbsp;&nbsp ").replace(/  /g,"&nbsp; ");},frozenAt:[],contextmenuTop:{"Toggle freeze columns to here":function(l){var k=l.getTdLocation(l.obj.tdActive()).col;l.frozenAt().col=(l.frozenAt().col==k?0:k);},"Insert column after":function(k){k.controlFactory.addColumn(k.colLast);return false;},"Insert column before":function(k){k.controlFactory.addColumn(k.colLast,true);return false;},"Add column to end":function(k){k.controlFactory.addColumn();return false;},"Delete this column":function(k){k.deleteColumn();return false;},"Hide column":function(k){k.toggleHide.column();return false;}},contextmenuLeft:{"Toggle freeze rows to here":function(k){var l=k.getTdLocation(k.obj.tdActive()).row;k.frozenAt().row=(k.frozenAt().row==l?0:l);},"Insert row after":function(k){k.controlFactory.addRow(k.rowLast);return false;},"Insert row before":function(k){k.controlFactory.addRow(k.rowLast,true);return false;},"Add row to end":function(k){k.controlFactory.addRow();return false;},"Delete this row":function(k){k.deleteRow();return false;},"Hide row":function(k){k.toggleHide.row();return false;}},contextmenuCell:{"Copy":false,"Cut":false,"Insert column after":function(k){k.controlFactory.addColumn(k.colLast);return false;},"Insert column before":function(k){k.controlFactory.addColumn(k.colLast,true);return false;},"Add column to end":function(k){k.controlFactory.addColumn();return false;},"Delete this column":function(k){k.deleteColumn();return false;},"line1":"line","Insert row after":function(k){k.controlFactory.addRow(k.rowLast);return false;},"Insert row before":function(k){k.controlFactory.addRow(k.rowLast,true);return false;},"Add row to end":function(k){k.controlFactory.addRow();return false;},"Delete this row":function(k){k.deleteRow();return false;},"line2":"line","Add spreadsheet":function(k){k.addSheet({rows:25,cols:10});},"Delete spreadsheet":function(k){k.deleteSheet();}},hiddenRows:[],hiddenColumns:[],cellStartingHandlers:{"$":function(l,k){this.formula="";this.value=l;this.valueOverride=jFN.DOLLAR.apply(this,[l.substring(1).replace(j.culture().numberFormat[","],""),2,k||"$"]).value;this.td.removeData("formula").html(l);},"£":function(k){g.s.cellStartingHandlers["$"].apply(this,[k,"£"]);}},cellEndHandlers:{"%":function(k){this.value=k;this.valueOverride=k.substring(0,this.value.length-1)/100;}}},d=jQuery.sheet.events;var g=f.getSheet();if(g){var c=f.children().detach();g.kill();f.html(c);for(var b in d){if(a[d[b]]){f.unbind(d[b]);}}}for(var b in d){if(a[d[b]]){f.bind(d[b],a[d[b]]);}}if(!jQuery.sheet.instance.length){jQuery.sheet.instance=$([]);}g=jQuery.sheet.createInstance(jQuery,jQuery.extend(h,a),jQuery.sheet.instance.length);jQuery.sheet.instance=jQuery.sheet.instance.add(g);});return this;},disableSelectionSpecial:function(){this.each(function(){this.onselectstart=function(){return false;};this.unselectable="on";jQuery(this).css("-moz-user-select","none");});return this;},getSheet:function(){return jQuery(this).data("sheetInstance");},getCellValue:function(f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{return c.updateCellValue(b,f,a);}catch(d){return"";}},setCellValue:function(d,g,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][g][a].value=d;return c.updateCellValue(b,g,a);}catch(f){}},setCellFormula:function(g,f,a,b){var c=jQuery(this).getSheet();b=(b?b:0);try{c.spreadsheets[b][f][a].formula=g;return c.updateCellValue(b,f,a);}catch(d){}},setCellHtml:function(c,g,a,b){var d=jQuery(this).getSheet();b=(b?b:0);try{d.spreadsheets[b][g][a].html=[c];return d.updateCellValue(b,g,a);}catch(f){}},isSheetFullScreen:function(){var a=$(this).getSheet();if(a.obj.fullScreen().is(":visible")){return true;}else{return false;}},serializeCellInputs:function(c){var b=$(this).getSheet(),a=b.obj.sheets().find(":input");if(c){return a.serializeArray();}else{return a.serialize();}},viewSource:function(b){var a="";if(b){jQuery(this).each(function(){a+=jQuery(this).toPrettySource();});}else{jQuery(this).each(function(){a+=jQuery(this).toCompactSource();});}$.print(a);return false;},toCompactSource:function(){var g=this[0];var b="";if(g.nodeType==1){b+="<"+g.tagName.toLowerCase();d=false;var j=g.attributes.length;for(var f=0,d=false;f<j;f++){var c=g.attributes[f].name,h=g.getAttribute(c);if(h){if(c=="contentEditable"&&h=="inherit"){continue;}if(c=="class"){d=true;}if(typeof(h)=="string"){b+=" "+c+'="'+h.replace(/"/g,"'")+'"';}else{if(c=="style"&&h.cssText){b+=' style="'+h.cssText+'"';}}}}if(g.tagName=="COL"){b+="/>";}else{b+=">";var a="";jQuery(g.childNodes).each(function(){a+=jQuery(this).toCompactSource();});b+=a;b+="</"+g.tagName.toLowerCase()+">";}}else{if(g.nodeType==3){b+=g.data.replace(/^\s*(.*)\s*$/g,"$1");}}return b;},toPrettySource:function(g){var f=this[0];g=g||"";var b="";if(f.nodeType==1){b+="\n"+g+"<"+f.tagName.toLowerCase();var j=f.attributes.length;for(var d=0;d<j;d++){var c=f.attributes[d].name,h=f.getAttribute(c);if(h){if(c=="contentEditable"&&h=="inherit"){continue;}if(typeof(h)=="string"){b+=" "+c+'="'+$.trim(h.replace(/"/g,"'"))+'"';}else{if(c=="style"&&h.cssText){b+=' style="'+$.trim(h.cssText)+'"';}}}}if(f.childNodes.length<=0){if(f.tagName=="COL"){b+="/>";}else{b+="></"+f.tagName.toLowerCase()+">";}}else{b+=">";var a="",j=f.childNodes.length;for(var d=0;d<j;d++){a+=$(f.childNodes[d]).toPrettySource(g+"  ");}b+=a;if(a.indexOf("\n")>=0){b+="\n"+g;}b+="</"+f.tagName.toLowerCase()+">";}}else{if(f.nodeType==3){b+=f.data.replace(/^\s*(.*)\s*$/g,"$1");}}return b;}});jQuery.sheet={instance:[],dependencies:{coreCss:{css:"jquery.sheet.css"},jQueryUI:{script:"jquery-ui/ui/jquery-ui.min.js"},jQueryUIThemeroller:{css:"jquery-ui/theme/jquery-ui.min.css"},globalize:{script:"plugins/globalize.js"},formulaParser:{script:"parser/formula/formula.js"},tsvParser:{script:"parser/tsv/tsv.js"},mousewheel:{script:"plugins/jquery.mousewheel.min.js"},nearest:{script:"plugins/jquery.nearest.min.js"}},optional:{globalizeCultures:{script:"plugins/globalize.cultures.js"},raphael:{script:"plugins/raphael-min.js"},gRaphael:{script:"plugins/g.raphael-min.js"},colorPicker:{css:"plugins/jquery.colorPicker.css"},colorPicker:{script:"plugins/jquery.colorPicker.min.js"},elastic:{script:"plugins/jquery.elastic.min.js"},advancedfn:{script:"plugins/jquery.sheet.advancedfn.js"},financefn:{script:"plugins/jquery.sheet.financefn.js"},dts:{script:"plugins/jquery.sheet.dts.js"},zeroclipboard:{script:"plugins/ZeroClipboard.js"}},events:["sheetAddRow","sheetAddColumn","sheetSwitch","sheetRename","sheetTabSortStart","sheetTabSortUpdate","sheetCellEdit","sheetCellEdited","sheetCalculation","sheetAdd","sheetDelete","sheetDeleteRow","sheetDeleteColumn","sheetOpen","sheetAllOpened","sheetSave","sheetFullScreen","sheetFormulaKeydown"],preLoad:function(d,b){d=d||"";b=$.extend({skip:["globalizeCultures"]},b);var c=function(){if(this.script){document.write('<script src="'+d+this.script+'"><\/script>');}else{if(this.css){document.write('<link rel="stylesheet" type="text/css" href="'+d+this.css+'"></link>');}}};for(var a in b.skip){if(this.dependencies[b.skip[a]]){this.dependencies[b.skip[a]]=null;}if(this.optional[b.skip[a]]){this.optional[b.skip[a]]=null;}}$.each(this.dependencies,function(){c.apply(this);});$.each(this.optional,function(){c.apply(this);});},repeat:function(c,b){var a="";while(b>0){if(b&1){a+=c;}b>>=1,c+=c;}return a;},nthCss:function(a,j,h,c,f,d){var g=[],b=c.length;d=d||"{display: none;}";if(h.styleSheet){do{if(c[b]>f){g.push(j+" "+a+":first-child"+this.repeat("+"+a,c[b]-1));}}while(b--);if(g.length){return g.join(",")+d;}}else{do{if(c[b]>f){g.push(j+" "+a+":nth-child("+c[b]+")");}}while(b--);if(g.length){return g.join(",")+d;}}return"";},createInstance:function(d,n,j){var m=this,f={version:"3.x",i:0,I:j,sheetCount:0,scrolledArea:[],spreadsheets:[],controls:{autoFiller:[],bar:{helper:[],corner:[],x:{controls:[],handleFreeze:[],menu:[],menuParent:[],parent:[],scroll:[],td:[],tds:function(){var p=d([]);for(var o in this.td[f.i]){p=p.add(this.td[f.i][o]);}return p;}},y:{controls:[],handleFreeze:[],menu:[],parent:[],scroll:[],td:[],tds:function(){var p=d([]);for(var o in this.td[f.i]){p=p.add(this.td[f.i][o]);}return p;}}},barMenuLeft:[],barMenuTop:[],barLeft:[],barTop:[],barTopParent:[],chart:[],tdMenu:[],cellsEdited:[],enclosure:[],enclosures:null,formula:null,fullScreen:[],header:null,inPlaceEdit:[],inputs:[],label:null,menuLeft:[],menuRight:[],pane:[],panes:null,scroll:[],scrolls:null,sheet:[],sheets:null,tab:[],tabContainer:null,tabs:null,title:null,toggleHide:{x:[],y:[]},ui:null},obj:{autoFiller:function(){return f.controls.autoFiller[f.i]||d([]);},barCorner:function(){return f.controls.bar.corner[f.i]||d([]);},barHelper:function(){return f.controls.bar.helper[f.i]||(f.controls.bar.helper[f.i]=d([]));},barLeft:function(o){return(f.controls.bar.y.td[f.i]&&f.controls.bar.y.td[f.i][o]?f.controls.bar.y.td[f.i][o]:d([]));},barLeftControls:function(){return f.controls.bar.y.controls[f.i]||d([]);},barLefts:function(){return f.controls.bar.y.tds();},barHandleFreezeLeft:function(){return f.controls.bar.y.handleFreeze[f.i]||d([]);},barMenuLeft:function(){return f.controls.bar.y.menu[f.i]||d([]);},barTop:function(o){return(f.controls.bar.x.td[f.i]&&f.controls.bar.x.td[f.i][o]?f.controls.bar.x.td[f.i][o]:d([]));},barTopControls:function(){return f.controls.bar.x.controls[f.i]||d([]);},barTops:function(){return f.controls.bar.x.tds();},barTopParent:function(){return f.controls.bar.x.parent[f.i]||d([]);},barHandleFreezeTop:function(){return f.controls.bar.x.handleFreeze[f.i]||d([]);},barMenuParentTop:function(){return f.controls.bar.x.menuParent[f.i]||d([]);},barMenuTop:function(){return f.controls.bar.x.menu[f.i]||d([]);},tdActive:function(){return f.cellLast.td||d([]);},tdMenu:function(){return f.controls.tdMenu[f.i]||d([]);},cellsEdited:function(){return f.controls.cellsEdited[f.i]||d([]);},chart:function(){return f.controls.chart[f.i]||d([]);},enclosure:function(){return f.controls.enclosure[f.i]||d([]);},enclosures:function(){return f.controls.enclosures||d([]);},formula:function(){return f.controls.formula||d([]);},fullScreen:function(){return f.controls.fullScreen[f.i]||d([]);},header:function(){return f.controls.header||d([]);},highlighted:function(){return f.highlightedLast.obj||d([]);},menuRight:function(){return f.controls.menuRight[f.i]||d([]);},inPlaceEdit:function(){return f.controls.inPlaceEdit[f.i]||d([]);},inputs:function(){return f.controls.inputs[f.i]||d([]);},label:function(){return f.controls.label||d([]);},menuLeft:function(){return f.controls.menuLeft[f.i]||d([]);},pane:function(){return f.controls.pane[f.i]||d([]);},panes:function(){return f.controls.panes||d([]);},parent:function(){return n.parent;},scrollStyleX:function(){return f.controls.bar.x.scroll[f.i]||d([]);},scrollStyleY:function(){return f.controls.bar.y.scroll[f.i]||d([]);},scroll:function(){return f.controls.scroll[f.i]||d([]);},scrolls:function(){return f.controls.scrolls||d([]);},sheet:function(){return f.controls.sheet[f.i]||d([]);},sheets:function(){return f.controls.sheets||d([]);},tab:function(){return f.controls.tab[f.i]||d([]);},tabs:function(){return f.controls.tabs||d([]);},tabContainer:function(){return f.controls.tabContainer||d([]);},toggleHideStyleX:function(){return f.controls.toggleHide.x[f.i]||d([]);},toggleHideStyleY:function(){return f.controls.toggleHide.y[f.i]||d([]);},title:function(){return f.controls.title||d([]);},ui:function(){return f.controls.ui||d([]);}},id:{sheet:"jS_"+j+"_"},cl:{autoFiller:"jSAutoFiller",autoFillerHandle:"jSAutoFillerHandle",autoFillerCover:"jSAutoFillerCover",barCorner:"jSBarCorner",barController:"jSBarController",barHelper:"jSBarHelper",barLeft:"jSBarLeft",barHandleFreezeLeft:"jSBarHandleFreezeLeft",barTop:"jSBarTop",barHandleFreezeTop:"jSBarHandleFreezeTop",barTopParent:"jSBarTopParent",chart:"jSChart",formula:"jSFormula",formulaParent:"jSFormulaParent",header:"jSHeader",fullScreen:"jSFullScreen",inPlaceEdit:"jSInPlaceEdit",menu:"jSMenu",menuFixed:"jSMenuFixed",parent:"jSParent",scroll:"jSScroll",sheet:"jS",label:"jSLoc",pane:"jSEditPane",tab:"jSTab",tabContainer:"jSTabContainer",title:"jSTitle",enclosure:"jSEnclosure",ui:"jSUI",uiAutoFiller:"ui-state-active",uiBar:"ui-widget-header",uiBarHighlight:"ui-state-active",uiBarHandleFreezeLeft:"ui-state-default",uiBarHandleFreezeTop:"ui-state-default",uiBarMenuTop:"ui-state-default",uiTdActive:"ui-state-active",uiTdHighlighted:"ui-state-highlight",uiControl:"ui-widget-header ui-corner-top",uiControlTextBox:"ui-widget-content",uiFullScreen:"ui-widget-content ui-corner-all",uiInPlaceEdit:"ui-state-highlight",uiMenu:"ui-widget-header",uiMenuUl:"ui-widget-header",uiMenuLi:"ui-widget-header",uiPane:"ui-widget-content",uiParent:"ui-widget-content ui-corner-all",uiSheet:"ui-widget-content",uiTab:"ui-widget-header",uiTabActive:"ui-state-highlight"},msg:{addRowMulti:"How many rows would you like to add?",addColumnMulti:"How many columns would you like to add?",cellFind:"What are you looking for in this spreadsheet?",cellNoFind:"No results found.",dragToFreezeCol:"Drag to freeze column",dragToFreezeRow:"Drag to freeze row",newSheet:"What size would you like to make your spreadsheet? Example: '5x10' creates a sheet that is 5 columns by 10 rows.",openSheet:"Are you sure you want to open a different sheet?  All unsaved changes will be lost.",toggleHideRow:"No row selected.",toggleHideColumn:"Now column selected.",loopDetected:"Loop Detected",newSheetTitle:"What would you like the sheet's title to be?",notFoundColumn:"Column not found",notFoundRow:"Row not found",notFoundSheet:"Sheet not found",setCellRef:"Enter the name you would like to reference the cell by.",sheetTitleDefault:"Spreadsheet {index}"},kill:function(){c.unbind("keydown");f.obj.fullScreen().remove();f.obj.inPlaceEdit().trigger("destroy");n.parent.removeClass(f.cl.uiParent).html("").removeData("sheetInstance");for(var o in d.sheet.events){n.parent.unbind(d.sheet.events[o]);}d.sheet.instance.splice(j,1);f=null;},trigger:function(o,p){p=p||[];n.parent.trigger(o,[f].concat(p));},spreadsheetsToArray:function(o){if(o||f.spreadsheets.length==0){f.cycleCellsAll(function(q,r,p){f.createCell(q,r,p);});}return f.spreadsheets;},spreadsheetToArray:function(p,o){o=(o?o:f.i);if(p||!f.spreadsheets[o]){f.cycleCells(function(r,s,q){f.createCell(r,s,q);});}},createCell:function(t,w,y,B,A,E){var p,u,x,D,z,q,r,o,v,s,F,C;if(!(p=f.spreadsheets[t])){p=f.spreadsheets[t]=[];}if(!(u=p[w])){u=p[w]=[];}if(!(D=f.controls.sheets[t])){return{};}if(!(r=D.children[1])){return{};}if(!(o=r.children[w])){return{};}if(!(v=o.children[y])){return{};}s=d(v);x=u[y]=v.jSCell={td:s,dependencies:{},formula:v.getAttribute("data-formula")||"",value:v.textContent||v.innerText||"",calcCount:B||0,calcLast:A||-1,calcDependenciesLast:E||-1,html:[],sheet:t,type:"cell",jS:f,state:[],needsUpdated:true};if(x.formula&&x.formula.charAt(0)=="="){x.formula=x.formula.substring(1);}z=D.children[0];if(!(q=z.children[y]).jSCells){q.jSCells=[];}q.jSCells.unshift(x);if(!q.tds){q.tds=[];}q.tds.unshift(v);v.col=q;if(!o.jSCells){o.jSCells=[];}o.jSCells.unshift(x);if(!o.tds){o.tds=[];}o.tds.unshift(v);if(!D.jSCells){D.jSCells=[];}D.jSCells.unshift(x);if(!D.tds){D.tds=[];}D.tds.unshift(v);v.table=D;if(!(C=f.controls.bar.y.td[t])){C=f.controls.bar.y.td[t]=[];}if(!C[w]){C[w]=d(o.children[0]);}if(!(F=f.controls.bar.x.td[t])){F=f.controls.bar.x.td[t]=[];}if(!F[y]){F[y]=d(r.children[0].children[y]);}return x;},nav:false,setNav:function(o){d.sheet.instance.each(function(){this.nav=false;});f.nav=o;},controlFactory:{addRowMulti:function(p,r,o,q){if(!r){r=prompt(f.msg.addRowMulti);}if(r){if(!isNaN(r)){f.controlFactory.addCells(p,o,parseInt(r),"row",q);f.trigger("sheetAddRow",[p,o,r]);}}},addColumnMulti:function(p,r,o,q){if(!r){r=prompt(f.msg.addColumnMulti);}if(r){if(!isNaN(r)){f.controlFactory.addCells(p,o,parseInt(r),"col",q);f.trigger("sheetAddColumn",[p,o,r]);}}},addCells:function(y,w,D,C,z){f.autoFillerHide();f.setDirty(true);f.setChanged(true);f.obj.barHelper().remove();var B=f.obj.sheet(),p=f.sheetSize(B),x=false,u=f.obj.tdActive(),r;D=D||1;C=C||"col";if(y==l){y=(C=="row"?p.rows:p.cols);x=true;}switch(C){case"row":r={el:function(){var o=f.rowTds(B,y);if(!o||!o[0]){return[];}return[o[0].parentNode];},size:function(){if(!r.Size){var o=r.el()[0];r.Size=o.children.length-1;}return r.Size;},loc:function(){var o=r.el();return f.getTdLocation(o[0].children);},trs:[],newObj:function(){var o=r.size(),F=h.createElement("tr");F.setAttribute("style","height: "+n.colMargin+"px;");for(var E=0;E<=o;E++){var G=h.createElement("td");if(E==0){G.setAttribute("class",f.cl.barLeft+" "+f.cl.uiBar);G.setAttribute("data-entity","left");G.setAttribute("data-type","bar");}F.appendChild(G);}r.trs.push(F);return F;},offset:{row:D,col:0},start:function(){return{row:(w?y:y+D)};},createCells:function(){for(var F=0;F<r.trs.length;F++){F=F*1;var E=(w?0:1)+y;f.spreadsheets[f.i].splice(F+E,0,[]);for(var o=0;o<r.trs[F].children.length;o++){o=o*1;if(o==0){f.controls.bar.y.td[f.i].splice(F+E,0,d(r.trs[F].children[o]));}else{f.createCell(f.i,F+E,o);}}}f.refreshRowLabels(y);}};break;case"col":r={el:function(){var E=f.rowTds(B,1)[y],H=f.rowTds(B),J=H[H.length-1],I=f.getTdLocation(E),G=f.getTdLocation(J),F=[];for(var o=0;o<=G.row;o++){F.push(B[0].children[1].children[o].children[I.col]);}return F;},col:function(){return f.col(B,y);},cols:[],newCol:function(){var o=h.createElement("col");o.setAttribute("style","width:"+f.s.newColumnWidth+"px;");r.cols.push(o);return o;},loc:function(o){o=(o?o:r.el());return f.getTdLocation(o[0]);},tds:[],newObj:function(){var o=h.createElement("td");r.tds.push(o);return o;},offset:{row:0,col:D},start:function(){return{col:(w?y:y+D)};},createCells:function(){var F=f.rows(B);for(var G=0;G<F.length;G++){var E=(w?0:1)+y,I=E+D,o=0;for(E;E<I;E++){var H=d(B[0].children[1].children[G].children[E]);if(G==0){f.controls.bar.x.td[f.i].splice(E,0,H);H.addClass(f.cl.barTop+" "+f.cl.uiBar).data("type","bar").data("entity","top").text(jSE.columnLabelString(E));r.cols[o].setAttribute("style","width:"+f.s.newColumnWidth+"px;");r.cols[o].bar=H[0];o++;}else{f.spreadsheets[f.i][G].splice(E,0,{});f.createCell(f.i,G,E);}}}f.refreshColumnLabels(y);}};break;}var q=r.el(),A=r.loc(q),s,v=q.length-1,t;if(w){do{t=D-1;do{q[v].parentNode.insertBefore(r.newObj(),q[v]);}while(t--);}while(v--);if(r.newCol){s=r.col();t=D-1;do{s.parentNode.insertBefore(r.newCol(),s);}while(t--);}}else{do{t=D-1;do{q[v].parentNode.insertBefore(r.newObj(),q[v].nextSibling);}while(t--);}while(v--);if(r.newCol){s=r.col();t=D-1;do{s.parentNode.insertBefore(r.newCol(),s.nextSibling);}while(t--);}}r.createCells();if(!z&&x!=true){f.offsetFormulas(A,r.offset,w);}f.obj.pane().trigger("resizeScroll");if(u&&u[0]&&u[0].cellIndex&&u[0].parentNode){f.colLast=u[0].cellIndex;f.rowLast=u[0].parentNode.rowIndex;}},addRow:function(p,o){f.controlFactory.addCells(p,o,1,"row");f.trigger("sheetAddRow",[p,o,1]);},addColumn:function(p,o){f.controlFactory.addCells(p,o,1,"col");f.trigger("sheetAddColumn",[p,o,1]);},barLeft:function(o){f.obj.barLefts().remove();o.children("tbody").children("tr").each(function(p){if(p>0){d(this).prepend("<td  />");}});},barTop:function(t){var q=t.children("colgroup"),u=q.children(),r,o=d("<col />").attr("width",n.colMargin).css("width",n.colMargin+"px").prependTo(q);f.obj.barTops().remove();var s=d('<tr class="'+f.cl.barTopParent+'" />');f.controls.barTopParent[f.i]=s;var w=t[0].children[1].children[0];var v=d("<td />");s.append(v);r=w.children.length-1;do{var p=h.createElement("td");if(!u[r]){u[r]=d(h.createElement("col")).prependTo(q);}u[r].bar=p;v.after(p);}while(r-->0);s.insertBefore(w);return s;},barHandleFreeze:{top:function(r){if(f.isBusy()){return false;}if(!(f.scrolledTo().col.end<=f.frozenAt().col+1)){return false;}f.obj.barHelper().remove();var o=f.obj.barTop(f.frozenAt().col+1),q=o.position(),p=d('<div class="'+f.cl.uiBarHandleFreezeTop+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeTop+'" />').height(n.colMargin+n.boxModelCorrection).css("top",q.top+"px").css("left",q.left+"px").attr("title",f.msg.dragToFreezeCol).prependTo(r);f.controls.bar.helper[f.i]=f.obj.barHelper().add(p);f.controls.bar.x.handleFreeze[f.i]=p;f.draggable(p,{axis:"x",start:function(){f.setBusy(true);},stop:function(u,s){f.setBusy(false);f.setDirty(true);var t=f.nearest(p,f.controls.bar.x.tds());f.obj.barHelper().remove();f.frozenAt().col=f.getTdLocation(t).col-1;f.evt.scroll.start("x",r);},containment:"parent"});},left:function(r){if(f.isBusy()){return false;}if(!(f.scrolledTo().row.end<=(f.frozenAt().row+1))){return false;}f.obj.barHelper().remove();var o=f.obj.barLeft(f.frozenAt().row+1),q=o.position(),p=d('<div class="'+f.cl.uiBarHandleFreezeLeft+" "+f.cl.barHelper+" "+f.cl.barHandleFreezeLeft+'" />').width(n.colMargin).css("top",q.top+"px").css("left",q.left+"px").attr("title",f.msg.dragToFreezeRow).prependTo(r);f.controls.bar.helper[f.i]=f.obj.barHelper().add(p);f.controls.bar.y.handleFreeze[f.i]=p;f.draggable(p,{axis:"y",start:function(){f.setBusy(true);},stop:function(u,s){f.setBusy(false);f.setDirty(true);var t=f.nearest(p,f.controls.bar.y.tds());f.obj.barHelper().remove();f.frozenAt().row=f.getTdLocation(t).row-1;f.evt.scroll.start("y",r);},containment:"parent"});},corner:function(){}},makeMenu:function(q,o){var s,p=d([]);switch(q){case"top":s=d('<div class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.bar.x.menu[f.i]=s;break;case"left":s=d('<div class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.bar.y.menu[f.i]=s;break;case"cell":s=d('<div class="'+f.cl.uiMenu+" "+f.cl.menu+'" />');f.controls.tdMenu[f.i]=s;break;}s.mouseleave(function(){s.hide();}).bind("contextmenu",function(){return false;}).appendTo(b).hide().disableSelectionSpecial();for(var r in o){if(o[r]){if(d.isFunction(o[r])){p=p.add(d("<div />").text(r).data("msg",r).click(function(){o[d(this).data("msg")].apply(this,[f]);return false;}).appendTo(s).hover(function(){p.removeClass("ui-state-highlight");d(this).addClass("ui-state-highlight");},function(){d(this).removeClass("ui-state-highlight");}));}else{if(o[r]=="line"){d("<hr />").appendTo(s);}}}}return s;},barMenu:{top:function(q,o,p){if(f.isBusy()){return false;}var s=f.obj.barMenuTop().hide();if(!s.length){s=f.controlFactory.makeMenu("top",n.contextmenuTop);}if(!p){s.css("left",(q.pageX-5)+"px").css("top",(q.pageY-5)+"px").show();return s;}var r=f.obj.barMenuParentTop().hide();if(!r.length){r=d('<div class="'+f.cl.uiBarMenuTop+" "+f.cl.barHelper+'">'+'<span class="ui-icon ui-icon-triangle-1-s" /></span>'+"</div>").mousedown(function(t){r.parent().mousedown().mouseup();var u=r.offset();s.css("left",(t.pageX-5)+"px").css("top",(t.pageY-5)+"px").show();}).blur(function(){if(s){s.hide();}}).css("padding-left",p.position().left+p.width()-n.colMargin).bind("destroy",function(){r.remove();f.controls.bar.x.menuParent[f.i]=null;});f.controls.bar.x.menuParent[f.i]=r;}r.prependTo(p).show();},left:function(p,o){if(f.isBusy()){return false;}f.obj.barMenuLeft().hide();if(o){f.obj.barHandleFreezeLeft().remove();}var q;q=f.obj.barMenuLeft();if(!q.length){q=f.controlFactory.makeMenu("left",n.contextmenuLeft);}q.css("left",(p.pageX-5)+"px").css("top",(p.pageY-5)+"px").show();return true;},corner:function(){}},tdMenu:function(o){if(f.isBusy()){return false;}f.obj.tdMenu().hide();var p=f.obj.tdMenu();if(!p.length){p=f.controlFactory.makeMenu("cell",n.contextmenuCell);}p.css("left",(o.pageX-5)+"px").css("top",(o.pageY-5)+"px").show();},header:function(){f.obj.header().remove();f.obj.tabContainer().remove();var v=f.controls.header=d('<div class="'+f.cl.header+'"></div>'),t=d("<table><tr /></table>").prependTo(v),r=d("<tr />");if(n.title){if(d.isFunction(n.title)){n.title=f.title(f,j);}r.append(f.controls.title=d('<td class="'+f.cl.title+'" />').html(n.title));}function s(w){if(d.isFunction(w)){w=d(w(f));}else{w=d(w);}if(w.is("ul")){w.find("ul").hide().addClass(f.cl.uiMenuUl);w.find("li").addClass(f.cl.uiMenuLi).hover(function(){d(this).find("ul:first").hide().show();},function(){d(this).find("ul:first").hide();});}return w;}if(f.isSheetEditable()){if(n.menuLeft){f.controls.menuLeft[f.i]=d('<td class="'+f.cl.menu+" "+f.cl.menuFixed+'" />').append(s(n.menuLeft)).prependTo(r);f.controls.menuLeft[f.i].find("img").load(function(){f.sheetSyncSize();});}if(n.menuRight){f.controls.menuRight[f.i]=d('<td class="'+f.cl.menu+" "+f.cl.menuFixed+'" />').append(s(n.menuRight)).appendTo(r);f.controls.menuRight[f.i].find("img").load(function(){f.sheetSyncSize();});}var q=d('<td class="'+f.cl.label+'"></td>');f.controls.label=q;var u=d('<textarea class="'+f.cl.formula+'"></textarea>').keydown(f.evt.keydownHandler.formulaKeydown).keyup(function(){f.obj.inPlaceEdit().val(f.obj.formula().val());}).change(function(){f.obj.inPlaceEdit().val(f.obj.formula().val());}).bind("paste",f.evt.pasteOverCells).focus(function(){f.setNav(false);}).focusout(function(){f.setNav(true);}).blur(function(){f.setNav(true);});f.controls.formula=u;var p=d('<table cellpadding="0" cellspacing="0" border="0"></table>').appendTo(v).append(d("<tr></tr>").append(q).append(d('<td class="'+f.cl.formulaParent+'"></td>').append(u)));var o=d("<span />");f.resizableSheet(f.obj.formula().wrap(o).parent(),{minHeight:f.obj.formula().height(),maxHeight:78,handles:"s",resize:function(x,w){f.obj.formula().height(w.size.height);f.sheetSyncSize();}});d.sheet.instance.each(function(){this.nav=false;});f.setNav(true);c.keydown(f.evt.keydownHandler.documentKeydown);}r.appendTo(t);return v;},ui:function(){return f.controls.ui=d('<div class="'+f.cl.ui+'">');},tabContainer:function(){var o=f.controls.tabContainer=d('<div class="'+f.cl.tabContainer+'"></div>').mousedown(function(s){var r=d(s.target).data("i")*1;if(r>=0){f.trigger("sheetSwitch",[r]);}return false;}).dblclick(function(s){var r=d(s.target).data("i")*1;if(r>=0){f.trigger("sheetRename",[d(s.target).data("i")*1]);}return false;});if(f.isSheetEditable()){var p=d('<span class="'+f.cl.uiTab+' ui-corner-bottom" title="Add a spreadsheet" data-i="-1">+</span>').mousedown(function(){f.addSheet({rows:25,cols:10});return false;}).appendTo(o);if(d.fn.sortable){var q;o.sortable({placeholder:"ui-state-highlight",axis:"x",forceHelperSize:true,forcePlaceholderSize:true,opacity:0.6,cancel:'span[i="-1"]',start:function(s,r){q=r.item.index();f.trigger("sheetTabSortStart",[s,r]);},update:function(s,r){f.trigger("sheetTabSortUpdate",[s,r,q]);}});}}else{d("<span />").appendTo(o);}return o;},scroll:function(r,p,u){var w=f.controls.scroll[f.i]=d('<div class="'+f.cl.scroll+'">'+"<div></div>"+"</div>").scroll(function(){if(!f.isBusy()){f.evt.scroll.scrollTo({axis:"x",pixel:this.scrollLeft},0);f.evt.scroll.scrollTo({axis:"y",pixel:this.scrollTop},0);f.autoFillerGoToTd();}}).prependTo(r).disableSelectionSpecial().mousedown(function(){f.obj.barHelper().remove();}),z=0,v=0;f.controls.scrolls=f.obj.scrolls().add(w);var s=w.children(),q=f.controls.bar.x.scroll[f.i]=d('<style type="text/css"></style>').bind("updateStyle",function(D,x,C){x=x||[];if(x.length==z){return;}z=x.length;var y=C||m.nthCss("col","#"+f.id.sheet+f.i,this,x,f.frozenAt().col+1)+m.nthCss("td","#"+f.id.sheet+f.i+" "+"tr",this,x,f.frozenAt().col+1);if(this.styleSheet){this.styleSheet.cssText=y;}else{q.text(y);}f.scrolledTo();f.scrolledArea[f.i].col.start=g.max(x.pop()||1,1);f.scrolledArea[f.i].col.end=g.max(x.shift()||1,1);f.obj.barHelper().remove();}).bind("touch",function(){var x;if(this.styleSheet){x=this.styleSheet.cssText+"";this.styleSheet.cssText=x;}else{x=q.text();q.text(x);}}),o=f.controls.bar.y.scroll[f.i]=d('<style type="text/css"></style>').bind("updateStyle",function(D,x,C){x=x||[];if(x.length==v){return;}v=x.length;var y=C||m.nthCss("tr","#"+f.id.sheet+f.i,this,x,f.frozenAt().row+1);if(this.styleSheet){this.styleSheet.cssText=y;}else{o.text(y);}f.scrolledTo();f.scrolledArea[f.i].row.start=g.max(x.pop()||1,1);f.scrolledArea[f.i].row.end=g.max(x.shift()||1,1);f.obj.barHelper().remove();});var t,B;function A(x){if(x&&x[0]&&x[0].styleSheet){return x[0].styleSheet.cssText;}return x.text();}p.append(q).append(o).bind("resizeScroll",function(){t=A(q);B=A(o);q.trigger("updateStyle");o.trigger("updateStyle");s.height(u.height()).width(u.width());w.height(r.height()).width(r.width());f.evt.scroll.start("x",p,u);f.evt.scroll.start("y",p,u);q.trigger("updateStyle",[null,t]);o.trigger("updateStyle",[null,B]);});if(!d.fn.mousewheel){return;}p.mousewheel(function(H,F){var M=H.originalEvent,H,I,C=function(y,x){return 0!=y%x?y:y/x;};if("mousewheel"==M.type){var N=1,D=C(-M.wheelDelta,N),L,K;if(M.wheelDeltaX!==l){w.scrollTop(w[0].scrollTop+C(-M.wheelDeltaY,N)).scrollLeft(w[0].scrollLeft+C(-M.wheelDeltaX,N)).scroll();}else{w.scrollTop(w[0].scrollTop+D).scroll();}}else{H=M.detail,100<H?H=3:-100>H&&(H=-3);var J=0,G=0;switch(H){case 1:case -1:G=H*50;break;case 3:case -3:J=H*15;break;}w.scrollTop(w[0].scrollTop+J).scrollLeft(w[0].scrollLeft+G).scroll();}return false;});},hide:function(s,u,q){u=u||f.obj.pane();var o=f.controls.toggleHide.x[f.i]=d("<style></style>").appendTo(u).bind("updateStyle",function(w){var v=m.nthCss("col","#"+f.id.sheet+f.i,this,f.toggleHide.hiddenColumns[f.i],0)+m.nthCss("td","#"+f.id.sheet+f.i+" tr",this,f.toggleHide.hiddenColumns[f.i],0);if(this.styleSheet){this.styleSheet.cssText=v;}else{o.text(v);}f.autoFillerGoToTd();}),t=f.controls.toggleHide.y[f.i]=d("<style></style>").appendTo(u).bind("updateStyle",function(w){var v=m.nthCss("tr","#"+f.id.sheet+f.i,this,f.toggleHide.hiddenRows[f.i],0);if(this.styleSheet){this.styleSheet.cssText=v;}else{t.text(v);}f.autoFillerGoToTd();});n.hiddenColumns[f.i]=n.hiddenColumns[f.i]||[];n.hiddenRows[f.i]=n.hiddenRows[f.i]||[];if(!n.hiddenColumns[f.i].length||!n.hiddenRows[f.i].length){n.hiddenRows[f.i]=arrHelpers.toNumbers((q.data("hiddenrows")||""+"").split(","));n.hiddenColumns[f.i]=arrHelpers.toNumbers((q.data("hiddencolumns")||""+"").split(","));}if(f.s.hiddenRows[f.i]){for(var r in f.s.hiddenRows[f.i]){f.toggleHide.row(f.s.hiddenRows[f.i][r]);}}if(n.hiddenColumns[f.i]){for(var p in n.hiddenColumns[f.i]){f.toggleHide.column(n.hiddenColumns[f.i][p]);}}},sheetUI:function(q,p){if(!p){f.sheetCount=1;f.i=0;}else{f.sheetCount++;f.i=p;}f.tuneTableForSheetUse(q);f.readOnly[p]=q.hasClass("readonly");var s=f.controlFactory.enclosure().appendTo(f.obj.ui()),u=f.obj.pane().html(q),o=function(x){x.preventDefault();if(f.isBusy()){return false;}if(f.isBar(x.target)){var y=d(x.target),v=y.data("entity"),w=f.getBarIndex[v](x.target);if(w<0){return false;}if(f.evt.barInteraction.first==f.evt.barInteraction.last){f.controlFactory.barMenu[v](x,w);}}else{f.controlFactory.tdMenu(x);}return false;};f.controlFactory.scroll(s,u,q);if(f.isSheetEditable()){var r=f.controlFactory.autoFiller();if(r){u.append(r);}}f.sheetDecorate(q);f.controlFactory.barTop(q);f.controlFactory.barLeft(q);f.sheetTab(true);if(f.isSheetEditable()){var t=f.obj.formula();u.mousedown(function(v){f.setNav(true);if(f.isBusy()){return false;}if(f.isTd(v.target)){if(v.button==2){o(v);}f.evt.cellOnMouseDown(v);return false;}if(f.isBar(v.target)){if(v.button==2){o(v);}f.evt.barInteraction.select(v.target);return false;}}).mouseover(function(y){if(f.isBusy()){return false;}if(!f.isBar(y.target)){return;}var x=d(y.target),v=x.data("entity"),w=f.getBarIndex[v](y.target);if(w<0){return false;}if(f.evt.barInteraction.selecting){f.evt.barInteraction.last=w;f.cellSetActiveBar(v,f.evt.barInteraction.first,f.evt.barInteraction.last);}else{f.resizeBar[v](x,w,u,q);if(f.isSheetEditable()){f.controlFactory.barHandleFreeze[v](u);if(v=="top"){f.controlFactory.barMenu[v](y,w,x);}}}}).bind("contextmenu",o).disableSelectionSpecial().bind("cellEdit",f.evt.cellEdit).dblclick(f.evt.cellOnDblClick);}f.themeRoller.start(q);f.resizableSheet(n.parent,{minWidth:n.width*0.1,minHeight:n.height*0.1,start:function(){s.hide();},stop:function(){s.show();n.width=n.parent.width();n.height=n.parent.height();u.trigger("resizeScroll");}});f.createSpreadsheet(q,f.i);f.checkMinSize(q);f.controlFactory.tab();f.controlFactory.hide(s,u,q);f.setChanged(true);return q;},enclosure:function(){var p=f.controls.pane[f.i]=d('<div class="'+f.cl.pane+" "+f.cl.uiPane+'"></div>'),o=f.controls.enclosure[f.i]=d('<div class="'+f.cl.enclosure+'"></div>').append(p);f.controls.panes=f.obj.panes().add(p);f.controls.enclosures=f.obj.enclosures().add(o);return o;},tab:function(){var o=f.controls.tab[f.i]=d('<span class="'+f.cl.uiTab+' ui-corner-bottom">'+'<a class="'+f.cl.tab+'" data-i="'+f.i+'">'+f.sheetTab(true)+"</a>"+"</span>").insertBefore(f.obj.tabContainer().find("span:last"));f.controls.tabs=f.obj.tabs().add(o);return o;},inPlaceEdit:function(q,s){q=q||f.obj.tdActive();if(!q.length){q=d(f.rowTds(null,1)[1]);f.cellEdit(q);}f.obj.inPlaceEdit().trigger("destroy");var u=f.obj.formula(),r=q.offset(),o=q.attr("style"),x=q.width(),t=q.height(),p=u.val();if(!r){return;}var v=f.controls.inPlaceEdit[f.i]=d('<textarea class="'+f.cl.inPlaceEdit+" "+f.cl.uiInPlaceEdit+'" data-i="'+f.i+'"/>').css("left",r.left).css("top",r.top).width(x).height(t).keydown(f.evt.inPlaceEditOnKeyDown).keyup(function(){u.val(v.val());}).change(function(){u.val(v.val());}).focus(function(){f.setNav(false);}).focusout(function(){f.setNav(true);}).blur(function(){f.setNav(true);}).bind("paste",f.evt.pasteOverCells).appendTo(b).val(u.val()).focus().bind("destroy",function(){f.cellLast.isEdit=(v.val()!=p);v.remove();f.controls.inPlaceEdit[v.data("i")]=false;});if(!s){v.select();}if(d.fn.elastic){v.elastic();}},autoFiller:function(){if(!n.autoFiller){return null;}f.controls.autoFiller[f.i]=d('<div class="'+f.cl.autoFiller+" "+f.cl.uiAutoFiller+'">'+'<div class="'+f.cl.autoFillerHandle+'" />'+'<div class="'+f.cl.autoFillerCover+'" />'+"</div>").mousedown(function(o){var q=f.obj.tdActive();if(q){var p=f.getTdLocation(q);f.cellSetActive(q,p,true,f.autoFillerNotGroup,function(){var s=f.highlighted(),r=f.getTdLocation(s.first());f.fillUpOrDown(r.row<p.row||r.col<p.col);f.autoFillerGoToTd(s.last());f.autoFillerNotGroup=false;});}});return f.controls.autoFiller[f.i];}},autoFillerNotGroup:true,updateCellsAfterPasteToFormula:function(x){var w=0,v=f.obj.formula(),z=new Date();x=x||v.val();var u={row:f.cellLast.row,col:f.cellLast.col},p=v.val(),r=p;if(u.row==0&&u.col==0){return false;}var A=tsv.parse(":::::"+p);if(!d.isArray(A)){v.val(A);f.fillUpOrDown(false,A);return true;}for(var t=0;t<A.length;t++){f.cellLast.isEdit=true;var o=A[t];for(var s=0;s<o.length;s++){w++;var q=f.getTd(f.i,t+u.row,s+u.col);q.row=u.row;q.col=u.col;if(q.length){if(!f.spreadsheets[f.i]||!f.spreadsheets[f.i][t+u.row]||!f.spreadsheets[f.i][t+u.row][s+u.col]){continue;}var y=f.spreadsheets[f.i][t+u.row][s+u.col];if(y){n.parent.one("sheetPreCalculation",function(){if((o[s]+"").charAt(0)=="="){y.formula=o[s].substring(1);y.value="";q.data("formula",o[s]);}else{y.formula="";y.value=o[s];q.removeData("formula");}});f.calcDependencies.apply(y);if(t==0&&s==0){r=o[s];}}}}}if(p!=r){v.val(r);}f.fillUpOrDown(false,r);f.evt.cellEditDone(true);},evt:{keydownHandler:{enterOnInPlaceEdit:function(o){if(!o.shiftKey){return f.evt.cellSetFocusFromKeyCode(o);}else{return true;}},enter:function(o){if(!f.cellLast.isEdit&&!o.ctrlKey){f.obj.tdActive().dblclick();return false;}else{return this.enterOnInPlaceEdit(o);}},tab:function(o){return f.evt.cellSetFocusFromKeyCode(o);},findCell:function(o){if(o.ctrlKey){f.cellFind();return false;}return true;},redo:function(o){if(o.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo();return false;}return true;},undo:function(o){if(o.ctrlKey&&!f.cellLast.isEdit){f.cellUndoable.undoOrRedo(true);return false;}return true;},copy:function(s,p){var r=f.highlighted(true),t=f.obj.formula(),q=t.val(),o=f.tdsToTsv(r,p);t.val(o).focus().select();c.one("keyup",function(){if(p){t.val("");}else{t.val(q);}});return true;},cut:function(o){return this.copy(o,true);},pageUpDown:function(o){var r=f.sheetSize(),v=f.obj.pane(),q=v.height(),s=0,t=0,u;if(o){for(var p=f.cellLast.row;p>0&&s<q;p--){u=f.getTd(f.i,p,1);if(!u.data("hidden")&&u.is(":hidden")){u.show();}s+=u.parent().height();}}else{for(var p=f.cellLast.row;p<r.rows&&s<q;p++){u=f.getTd(f.i,p,1);s+=u.parent().height();}}f.cellEdit(u);return false;},formulaKeydown:function(o){if(f.readOnly[f.i]){return false;}if(f.cellLast.row<0||f.cellLast.col<0){return false;}f.trigger("sheetFormulaKeydown",[false]);switch(o.keyCode){case key.C:if(o.ctrlKey){return f.evt.keydownHandler.copy(o);}else{f.obj.tdActive().dblclick();return true;}case key.X:if(o.ctrlKey){return f.evt.keydownHandler.cut(o);}else{f.obj.tdActive().dblclick();return true;}case key.Y:if(o.ctrlKey){f.evt.keydownHandler.redo(o);return false;}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.Z:if(o.ctrlKey){f.evt.keydownHandler.undo(o);return false;}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.ESCAPE:f.evt.cellEditAbandon();break;case key.ENTER:f.evt.cellSetFocusFromKeyCode(o);return false;break;default:f.cellLast.isEdit=true;}},formulaKeydownIf:function(p,o){if(p){f.obj.tdActive().dblclick();return true;}return false;},documentKeydown:function(o){if(f.readOnly[f.i]){return false;}if(f.cellLast.row<0||f.cellLast.col<0){return false;}if(f.nav){switch(o.keyCode){case key.DELETE:f.tdsToTsv(null,true);f.obj.formula().val("");break;case key.TAB:f.evt.keydownHandler.tab(o);break;case key.ENTER:case key.LEFT:case key.UP:case key.RIGHT:case key.DOWN:(o.shiftKey?f.evt.cellSetHighlightFromKeyCode(o):f.evt.cellSetFocusFromKeyCode(o));break;case key.PAGE_UP:f.evt.keydownHandler.pageUpDown(true);break;case key.PAGE_DOWN:f.evt.keydownHandler.pageUpDown();break;case key.HOME:case key.END:f.evt.cellSetFocusFromKeyCode(o);break;case key.V:if(o.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(!f.evt.pasteOverCells(o),o);}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.Y:if(o.ctrlKey){f.evt.keydownHandler.redo(o);return false;}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.Z:if(o.ctrlKey){f.evt.keydownHandler.undo(o);return false;}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.ESCAPE:f.evt.cellEditAbandon();break;case key.F:if(o.ctrlKey){return f.evt.keydownHandler.formulaKeydownIf(f.evt.keydownHandler.findCell(o),o);}else{f.obj.tdActive().trigger("cellEdit");return true;}break;case key.CAPS_LOCK:case key.SHIFT:case key.ALT:break;case key.CONTROL:f.obj.formula().focus().select();return true;break;default:f.obj.tdActive().trigger("cellEdit");return true;break;}return false;}}},pasteOverCells:function(q){if(q.ctrlKey||q.type=="paste"){var p=function(){f.updateCellsAfterPasteToFormula();};var o=c.one("keyup",function(){p();p=function(){};o.mouseup();}).one("mouseup",function(){p();p=function(){};o.keyup();});f.setDirty(true);f.setChanged(true);return true;}},inPlaceEditOnKeyDown:function(o){f.trigger("sheetFormulaKeydown",[true]);switch(o.keyCode){case key.ENTER:return f.evt.keydownHandler.enterOnInPlaceEdit(o);break;case key.TAB:return f.evt.keydownHandler.tab(o);break;case key.ESCAPE:f.evt.cellEditAbandon();return false;break;}},cellEditDone:function(q){f.obj.inPlaceEdit().trigger("destroy");if(f.cellLast.isEdit||q){var s=f.obj.formula(),r=f.obj.tdActive();if(f.isFormulaEditable(r)){if(r&&f.cellLast.row>0&&f.cellLast.col>0){var p=s.val(),o=r[0].jSCell;if(!o.edited){o.edited=true;f.controls.cellsEdited[f.i]=f.obj.cellsEdited().add(o);}n.parent.one("sheetPreCalculation",function(){if(p.charAt(0)=="="){r.data("formula",p);o.value=p;o.formula=p;}else{r.removeData("formula");o.value=p;o.formula="";}});f.calcDependencies.apply(o);f.cellLast.isEdit=false;f.trigger("sheetCellEdited",[o]);}}}},cellEditAbandon:function(o){f.obj.inPlaceEdit().trigger("destroy");f.themeRoller.bar.clearActive();f.themeRoller.cell.clearHighlighted(null,true);if(!o){f.calc();}f.cellLast.td=d([]);f.cellLast.row=0;f.cellLast.col=0;f.rowLast=0;f.colLast=0;f.labelUpdate("",true);f.obj.formula().val("");f.autoFillerHide();return false;},cellSetFocusFromXY:function(p,o){var q=f.getTdFromXY(p,o);if(f.isTd(q)){q=d(q);f.cellEdit(q);return false;}return true;},cellSetHighlightFromKeyCode:function(q){var s=f.obj.tdActive(),r=f.getTdLocation(s),o=f.sheetSize(),s;switch(q.keyCode){case key.UP:r.row--;break;case key.DOWN:r.row++;break;case key.LEFT:r.col--;break;case key.RIGHT:r.col++;break;}function p(u,t){if(u<1){return 1;}if(u>t){return t;}return u;}r.row=p(r.row,o.rows);r.col=p(r.col,o.cols);s=f.getTd(f.i,r.row,r.col).mousemove().mouseup();f.themeRoller.cell.setHighlighted(s);return false;},cellSetFocusFromKeyCode:function(t){var w=f.cellLast.col,p=f.cellLast.row,s=false;switch(t.keyCode){case key.UP:p--;break;case key.DOWN:p++;break;case key.LEFT:w--;break;case key.RIGHT:w++;break;case key.ENTER:p++;s=true;if(f.highlightedLast.obj.length>1){var q=f.obj.inPlaceEdit(),o=q.val();q.trigger("destroy");f.updateCellsAfterPasteToFormula(o);return true;}else{if(n.autoAddCells){if(f.cellLast.row==f.sheetSize().rows){f.controlFactory.addRow();}}}break;case key.TAB:s=true;if(t.shiftKey){w--;}else{w++;}if(n.autoAddCells){if(f.cellLast.col==f.sheetSize().cols){f.controlFactory.addColumn();}}break;case key.HOME:w=1;break;case key.END:w=f.obj.tdActive().parent().children("td").length-1;break;}w=(w?w:1);p=(p?p:1);if(!f.cellLast.isEdit||s){var u=f.getTd(f.i,p,w);if(u){f.cellEdit(u);return false;}}return true;},cellOnMouseDown:function(o){f.obj.formula().blur();if(o.shiftKey){f.getTdRange(o,f.obj.formula().val());}else{f.cellEdit(d(o.target),true);}},cellOnDblClick:function(o){if(f.isBusy()){return false;}f.controlFactory.inPlaceEdit(null,true);},cellEdit:function(o){if(f.isBusy()){return false;}f.controlFactory.inPlaceEdit();},barInteraction:{first:0,last:0,selecting:false,select:function(r){if(!r){return;}if(!f.isBar(r)){return;}r=d(r);var p=r.data("entity"),q=f.getBarIndex[p](r[0]);if(q<0){return false;}f[p+"Last"]=q;f.evt.barInteraction.last=f.evt.barInteraction.first=q;f.cellSetActiveBar(p,f.evt.barInteraction.first,f.evt.barInteraction.last);f.evt.barInteraction.first=f.evt.barInteraction.last=f[p+"Last"]=q;f.evt.barInteraction.selecting=true;c.one("mouseup",function(){f.evt.barInteraction.selecting=false;});return false;}},scroll:{axis:{x:{},y:{}},size:{},td:{},start:function(r,u,q){f.autoFillerHide();u=u||f.obj.pane();q=q||f.obj.sheet();var s=f.evt.scroll;s.size=f.sheetSize(q);s.td=f.obj.tdActive();s.axis[r].v=[];s.axis[r].p=[];switch(r||"x"){case"x":var o=s.axis.x;o.max=s.size.cols;o.min=1;o.scrollStyle=f.obj.scrollStyleX().trigger("updateStyle");o.area=u.width();o.sheetArea=q.width();o.scrollUpdate=function(v){v=v||f.obj.scroll();v.scrollLeft(o.value*(v.width()/s.size.cols));return;};break;case"y":var t=s.axis.y;t.max=s.size.rows;t.min=1;t.scrollStyle=f.obj.scrollStyleY().trigger("updateStyle");t.area=u.height();t.sheetArea=q.height();t.scrollUpdate=function(v){v=v||f.obj.scroll();v.scrollTop(t.value*(v.height()/s.size.rows));return;};break;}s.axis[r].gridSize=100/(s.axis[r].max-s.axis[r].min);for(var p=s.axis[r].min;p<=s.axis[r].max;p++){s.axis[r].v[p]=s.axis[r].gridSize*p;s.axis[r].p[s.axis[r].gridSize*p]=p+1;}},scrollTo:function(r){r=r||{};r.axis=r.axis||"x";r.value=r.value||0;r.pixel=r.pixel||1;if(!f.evt.scroll.axis){f.evt.scroll.start(r.axis);}var q=f.evt.scroll.axis[r.axis];if(!r.value){if(!q.p){return;}r.value=q.p[arrHelpers.closest(q.v,Math.abs(r.pixel/(q.sheetArea-q.area))*100,q.min)];}r.max=r.max||q.max;var p=((r.value>r.max?r.max:r.value)-q.min)-1,o=[];if(p>0){do{o.push(p+q.min);}while(p--);}if(o.length){if(q.scrollStyle){q.scrollStyle.trigger("updateStyle",[o]);}}else{if(q.scrollStyle){q.scrollStyle.trigger("updateStyle");}}q.value=r.value;},stop:function(){if(this.axis.x.scrollUpdate){this.axis.x.scrollUpdate();}if(this.axis.y.scrollUpdate){this.axis.y.scrollUpdate();}if(f.evt.scroll.td){f.evt.scroll.td=null;f.autoFillerGoToTd();}}}},refreshColumnLabels:function(q){q=q||0;f.obj.barMenuParentTop().trigger("destroy");var p=f.controls.bar.x.td[f.i];if(!p){return;}for(var o=q;o<p.length;o++){if(o){d(p[o]).text(jSE.columnLabelString(o));}}},refreshRowLabels:function(q){q=q||0;var p=f.controls.bar.y.td[f.i];if(!p){return;}for(var o=q;o<p.length;o++){if(o){d(p[o]).text(o);}}},isTd:function(p){if(!p){return false;}p=(p[0]?p[0]:[p]);if(p[0]){if(!isNaN(p[0].cellIndex)){if(p[0].cellIndex>0&&p[0].parentNode.rowIndex>0){return true;}}}return false;},isBar:function(p){if(!p){return false;}p=(p[0]?p[0]:[p]);if(p[0]){if(!isNaN(p[0].cellIndex)){if(p[0].cellIndex==0||p[0].parentNode.rowIndex==0){return true;}}}return false;},readOnly:[],isSheetEditable:function(o){o=o||f.i;return(n.editable==true&&!f.readOnly[o]);},isFormulaEditable:function(p){if(n.lockFormulas){if(p.data("formula")!==l){return false;}}return true;},toggleFullScreen:function(){if(!f){return;}f.evt.cellEditDone();var p=f.obj.fullScreen();if(p.is(":visible")){b.removeClass("bodyNoScroll");n.parent=p.data("parent");var o=n.parent.width(),r=n.parent.height();n.width=o;n.height=r;n.parent.append(p.children());p.remove();f.sheetSyncSize();f.obj.pane().trigger("resizeScroll");f.trigger("sheetFullScreen",[false]);}else{b.addClass("bodyNoScroll");var o=a.width()-15,r=a.height()-15,q=n.parent;n.width=o;n.height=r;n.parent=f.controls.fullScreen[f.i]=d('<div class="'+f.cl.fullScreen+" "+f.cl.uiFullScreen+'" />').append(n.parent.children()).appendTo(b).data("parent",n.parent);f.obj.pane().trigger("resizeScroll");f.sheetSyncSize();q.trigger("sheetFullScreen",[true]);}},renameSheet:function(o){if(isNaN(o)){return false;}if(o>-1){f.sheetTab();}},switchSheet:function(o){if(isNaN(o)){return false;}if(o==-1){f.addSheet("5x10");}else{if(o!=f.i){f.setActiveSheet(o);f.calc(o);}}},tuneTableForSheetUse:function(r){f.controls.sheet[f.i]=r.addClass(f.cl.sheet).attr("id",f.id.sheet+f.i).attr("border","1px").attr("cellpadding","0").attr("cellspacing","0");f.controls.sheets=f.obj.sheets().add(r);var q=r.data("frozenatrow"),p=r.data("frozenatcol");if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0};}if(q){f.s.frozenAt[f.i].row=q;}if(p){f.s.frozenAt[f.i].col=p;}return r;},createSpreadsheet:function(p,o,r){p=p||f.obj.sheet();o=o||f.i;r=d.extend({row:0,col:0},r);f.spreadsheets[o]=[];var q=f.rows(p);d(q).each(function(s){d(this).children().each(function(t){var u=d(this);if(s>0&&t>0){f.createCell(o,s,t);}else{if(t==0&&s>0){u.data("type","bar").data("entity","left").text(s).attr("class",f.cl.barLeft+" "+f.cl.barLeft+"_"+f.i+" "+f.cl.uiBar);}if(s==0&&t>0){u.data("type","bar").data("entity","top").text(jSE.columnLabelString(t)).attr("class",f.cl.barTop+" "+f.cl.barTop+"_"+f.i+" "+f.cl.uiBar);}if(s==0&&t==0){f.controls.bar.corner[f.i]=u.data("type","bar").data("entity","corner").attr("class",f.cl.uiBar+" "+" "+f.cl.barCorner);}}});});},toggleHide:{hiddenRows:[],row:function(p){p=p||f.rowLast;if(!p){return;}var r=f.rows()[p],o=d(r),q=[];if(!this.hiddenRows[f.i]){this.hiddenRows[f.i]=[];}if(o.length&&d.inArray(p+1,this.hiddenRows[f.i])<0){this.hiddenRows[f.i].push(p+1);}else{this.hiddenRows[f.i].splice(this.hiddenRows[f.i].indexOf(p+1),1);}f.obj.toggleHideStyleY().trigger("updateStyle");},rowShowAll:function(){d.each(this.hiddenRows[f.i],function(o){d(this).removeData("hidden");});f.obj.toggleHideStyleY().html("");this.hiddenRows[f.i]=[];},hiddenColumns:[],columnIndexOffset:[],column:function(p){p=p||f.colLast;if(!p){return;}var o=f.cols()[p],r=d(o),q=[];if(!this.hiddenColumns[f.i]){this.hiddenColumns[f.i]=[];}if(r.length&&d.inArray(p+1,this.hiddenColumns[f.i])<0){this.hiddenColumns[f.i].push(p+1);}else{this.hiddenColumns[f.i].splice(this.hiddenColumns[f.i].indexOf(p+1),1);}f.obj.toggleHideStyleX().trigger("updateStyle");},columnShowAll:function(){f.obj.toggleHideStyleX().html("");this.hiddenColumns[f.i]=[];}},merged:[],merge:function(){var r=[],s=f.highlighted(),u=f.getTdLocation(s.first()),w=f.getTdLocation(s.last()),v=0,z=0,x=f.spreadsheets[f.i][u.row][u.col],B=new Date();if(s.length>1&&u.row){f.setDirty(true);f.setChanged(true);if(!f.merged[f.i+"_"+u.row+"_"+u.col]){f.merged[f.i+"_"+u.row+"_"+u.col]=[];}var y=f.merged[f.i+"_"+u.row+"_"+u.col];for(var E=u.row;E<=w.row;E++){if(E){z++;}for(var o=u.col;o<=w.col;o++){if(E==u.row){v++;}var p=f.getTd(f.i,E,o),A=f.spreadsheets[f.i][E][o],q=f.spreadsheets[f.i][E][u.col-1]||f.spreadsheets[f.i][E][u.col],D=f.spreadsheets[f.i][E][w.col+1]||f.spreadsheets[f.i][E][w.col],t=f.spreadsheets[f.i][w.row-1][w.col]||f.spreadsheets[f.i][w.row][w.col],C=f.spreadsheets[f.i][w.row+1][w.col]||f.spreadsheets[f.i][w.row][w.col];y.push(A);r.push(A.formula?"("+A.formula.substring(1)+")":A.value);n.parent.one("sheetPreCalculation",function(){if(o!=u.col||E!=u.row){A.formula=null;A.value="";A.html="";A.defer=x;A.right=D;A.down=C;A.left=q;A.up=t;p.removeData("formula").html("").hide();}});f.calcDependencies.apply(A);}}x.value=r.join(" ");x.formula=(x.formula?r.join(" "):"");s.first().show().attr("rowSpan",z).attr("colSpan",v);f.calcDependencies.apply(s.first()[0].jSCell);f.evt.cellEditDone();}},unmerge:function(){var q=f.highlighted().first(),s=f.getTdLocation(q),t=f.spreadsheets[f.i][s.row][s.col],u=q.data("formula"),w=new Date();var o=g.max(q.attr("rowSpan")*1,1);var r=g.max(q.attr("colSpan")*1,1);for(var x=s.row;x<=s.row+o;x++){for(var p=s.col;p<=s.col+r;p++){var q=f.getTd(f.i,x,p).show().removeAttr("colSpan").removeAttr("rowSpan"),v=q.cell;v.up=v.down=v.left=v.right=v.defer=null;f.calcDependencies.apply(v,[w]);}}},fillUpOrDown:function(w,y){f.evt.cellEditDone();var A=f.highlighted(true),s=f.obj.tdActive(),x=new Date(),t=f.getTdLocation(A[0].td),B=f.getTdLocation(A[A.length-1].td),o=f.getTdLocation(s),q={row:0,col:0},p=y||s[0].jSCell.value,z=false,r=A.length-1,u=function(){};y=y||s[0].jSCell.value;if(r>=0){if(y.charAt&&y.charAt(0)=="="){if(r>=0){do{if(!w){q.row=o.row-B.row;q.col=o.col-B.col;}else{q.row=o.row-t.row;q.col=o.col-t.col;}p=f.reparseFormula(y,q);n.parent.one("sheetPreCalculation",function(){A[r].formula=p;A[r].value="";A[r].td.data("formula",p);});f.calcDependencies.apply(A[r],[x]);}while(r--);return true;}}else{if((z=!isNaN(p))||p.length>0){if(z&&p!=""){p*=1;if(!w){p+=A.length-1;}u=function(){p--;};}}do{n.parent.one("sheetPreCalculation",function(){A[r].formula="";A[r].value=p;A[r].td.removeData("formula");});f.calcDependencies.apply(A[r],[x]);u();}while(r--);}}return false;},tdsToTsv:function(z,r,x){z=z||f.highlighted(true);if(z.type){z=[z];}x=x||function(C,B){if(r){n.parent.one("sheetPreCalculation",function(){B.formula="";B.value="";});f.calcDependencies.apply(B,[w]);}};var u=[],y,t,p={},w=new Date(),q=z.length-1,A,o;if(q>=0){y=f.getTdLocation(z[0].td);t=f.getTdLocation(z[z.length-1].td);p.row=g.min(y.row,t.row);p.col=g.min(y.col,t.col);do{var s=f.getTdLocation(z[q].td),v=(z[q].formula?"="+z[q].formula:z[q].value);A=g.abs(s.row-p.row);o=g.abs(s.col-p.col);if(!u[A]){u[A]=[];}if((v+="").match(/\n/)){v='"'+v+'"';}u[A][o]=(v||"");x.apply(z[q].td,[s,z[q]]);}while(q-->0);q=u.length-1;do{u[q]=u[q].join("\t");}while(q-->0);return u.join("\n");}return"";},offsetFormulas:function(v,u,q){var p=f.sheetSize(),t={first:v,last:{row:p.rows,col:p.cols}},s={first:{row:1,col:1},last:{row:p.rows,col:p.cols}},r=new Date(),o=[];f.cycleCells(function(){var w=this;if(this.formula&&typeof this.formula=="string"&&f.isFormulaEditable(this.td)){this.formula=f.reparseFormula(this.formula,u,v,q);this.td.data("formula","="+this.formula);}o.push(function(){f.calcDependencies.apply(w,[r,true]);});},s.first,s.last);while(o.length){o.pop()();}f.evt.cellEditDone();},reparseFormula:function(r,q,p,o){return r.replace(jSE.regEx.cell,function(t,u,y,z){if(u=="SHEET"){return t;}q=q||{loc:0,row:0};var s={row:y*1,col:jSE.columnLabelIndex(u)},x,w,v={col:u,row:y};if(p){if(s.col==p.col||u=="#REF!"){v.col="#REF!";v.use=true;}if(s.row==p.row||y=="#REF!"){v.row="#REF!";v.use=true;}if(v.use){return v.col+v.row;}if(o){if(s.col>p.col){x=true;}if(s.row>p.row){w=true;}}else{if(s.col>p.col){x=true;}if(s.row>p.row){w=true;}}if(x||w){if(x){s.col+=q.col;}if(w){s.row+=q.row;}return f.makeFormula(s);}}else{return f.makeFormula(s,q);}return t;});},makeFormula:function(p,o){o=d.extend({row:0,col:0},o);p.col+=o.col;p.row+=o.row;if(p.col<0){p.col=0;}if(p.row<0){p.row=0;}return jSE.parseCellName(p.col,p.row);},cycleCells:function(r,u,s,q){q=q||f.i;u=u||{row:1,col:1};if(!s){var p=f.sheetSize();s={row:p.rows,col:p.cols};}var t=s.row,o;if(t<u.row){return;}do{o=s.col;do{r.apply(f.spreadsheets[q][t][o],[q,t,o]);}while(o-->u.col);}while(t-->u.row);},cycleCellsAll:function(r){var s=f.i,q,p,o;for(q=0;q<=f.sheetCount;q++){f.i=q;p=f.sheetSize();o={row:p.rows,col:p.cols};f.cycleCells(r,{row:0,col:0},o,q);}f.i=s;},cycleCellArea:function(w,y,u){var v=g.max(g.min(y.row,u.row),1),A=g.max(g.min(y.col,u.col),1),p=g.max(y.row,u.row,1),s=g.max(y.col,u.col,1),z=p,r,x,t=f.i,q={cell:d([]),td:d([])};w=w||function(){};do{r=s;do{x=f.spreadsheets[t][z][r];q.cell=q.cell.add(x);q.td=q.td.add(x.td);}while(r-->A);}while(z-->v);w(q);},sheetDecorate:function(p){f.formatSheet(p);f.sheetDecorateRemove(false,p);},formatSheet:function(u){var p=n.newColumnWidth,s=n.colMargin,r=u.children("tbody");if(r.length<1){r=d("<tbody />");u.wrapInner(r);}var q=u.children("colgroup");if(q.length<1||q.children("col").length<1){u.remove("colgroup");q=d("<colgroup />").prependTo(u);var t=r.children("tr:first");t.children().each(function(){d("<col />").width(p).css("width",p+"px").attr("width",p+"px").appendTo(q);});r.children("tr").each(function(){d(this).height(s).css("height",s+"px").attr("height",s+"px");});}u.removeAttr("width").css("width","");},checkMinSize:function(r){var q=f.sheetSize(r),s=0,p=0;if(q.cols<n.minSize.cols){f.controlFactory.addColumnMulti(null,n.minSize.cols-q.cols);}if(q.rows<n.minSize.rows){f.controlFactory.addRowMulti(null,n.minSize.rows-q.rows);}},themeRoller:{start:function(o){n.parent.addClass(f.cl.uiParent);o.addClass(f.cl.uiSheet);f.obj.header().addClass(f.cl.uiControl);f.obj.label().addClass(f.cl.uiControl);f.obj.formula().addClass(f.cl.uiControlTextBox);},cell:{setHighlighted:function(r,q){var p,s=f.highlightedLast.obj,o=f.obj.scrollStyleX();if(s&&s.length&&!q){p=s.length-1;do{s[p].isHighlighted=false;}while(p-->0);}if(r&&r.length>0){p=r.length-1;do{if(!r[p].isHighlighted){r[p].className+=" "+f.cl.uiTdHighlighted;r[p].isHighlighted=true;}}while(p-->0);}if(q){f.highlightedLast.obj=f.highlightedLast.obj.add(r);}else{f.themeRoller.cell.clearHighlighted(s);if(r){f.highlightedLast.obj=r;}}o.trigger("touch");},isHighlighted:function(){return(f.highlightedLast.obj.length?true:false);},clearHighlighted:function(p,o){if(f.themeRoller.cell.isHighlighted()){p=p||f.highlightedLast.obj;if(p&&p.length){i=p.length-1;do{if(!p[i].isHighlighted||o){p.eq(i).removeClass(f.cl.uiTdHighlighted);}}while(i-->0);}}f.highlightedLast.obj=d([]);}},bar:{style:function(p){d(p).addClass(f.cl.uiBar);},setActive:function(p,o){switch(p){case"top":f.highlightedLast.barTop.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barTop=f.obj.barTop(o).addClass(f.cl.uiBarHighlight);break;case"left":f.highlightedLast.barLeft.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barLeft=f.obj.barLeft(o).addClass(f.cl.uiBarHighlight);break;}},clearActive:function(){f.highlightedLast.barLeft.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barLeft=d([]);f.highlightedLast.barTop.removeClass(f.cl.uiBarHighlight);f.highlightedLast.barTop=d([]);}},tab:{setActive:function(p){this.clearActive();f.obj.tab().addClass(f.cl.uiTabActive);},clearActive:function(){f.obj.tabContainer().find("span."+f.cl.uiTabActive).removeClass(f.cl.uiTabActive);}}},resizable:function(q,p){if(!q.data("resizable")){q.resizable(p);}},frozenAt:function(){if(!f.s.frozenAt[f.i]){f.s.frozenAt[f.i]={row:0,col:0};}return f.s.frozenAt[f.i];},scrolledTo:function(){if(!f.scrolledArea[f.i]){var o=f.frozenAt();f.scrolledArea[f.i]={col:{start:g.max(o.col,1),end:g.max(o.col,1)},row:{start:g.max(o.row,1),end:g.max(o.row,1)}};}return f.scrolledArea[f.i];},busy:[],setBusy:function(o){if(o){f.busy.push(o);}else{f.busy.pop();}},isBusy:function(){return(f.busy.length>0?true:false);},draggable:function(q,p){if(!q.data("jSdraggable")){q.data("jSdraggable",true).draggable(p);}},nearest:function(q,p){return d(q).nearest(p);},resizeBar:{top:function(r,p,s,o){f.obj.barTopControls().remove();var q=d('<div class="'+f.cl.barController+'" />').width(r.width()).height(0).prependTo(r);f.controls.bar.x.controls[f.i]=f.obj.barTopControls().add(q);f.resizableCells(q,{handles:"e",start:function(u,t){f.autoFillerHide();f.setBusy(true);this.col=d(f.col(o,p));},resize:function(u,t){this.col.width(t.size.width).attr("width",t.size.width+"px").css("width",t.size.width+"px");},stop:function(u,t){f.setBusy(false);s.trigger("resizeScroll");f.followMe();f.setDirty(true);}});},left:function(s,p,v,o){f.obj.barLeftControls().remove();var t=s.offset(),q=d('<div class="'+f.cl.barController+'"></div>').prependTo(s).offset({top:t.top,left:t.left});f.controls.bar.y.controls[f.i]=f.obj.barLeftControls().add(q);var u=d('<div class="barControllerChild"></div>').height(s.height()).prependTo(q),r=s.parent().add(s).add(q);f.resizableCells(u,{handles:"s",start:function(){f.autoFillerHide();f.setBusy(true);},resize:function(x,w){r.height(w.size.height).attr("height",(w.size.height)).css("height",w.size.height+"px");},stop:function(x,w){f.setBusy(false);v.trigger("resizeScroll");f.followMe();f.setDirty(true);}});},corner:function(){}},sheetDecorateRemove:function(p,o){o=o||f.obj.sheets();o=(p?o.clone():o);o.find("td."+f.cl.uiTdActive).removeClass(f.cl.uiTdActive);o.find("td."+f.cl.uiTdHighlighted).removeClass(f.cl.uiTdHighlighted);return o;},sheetBarsRemove:function(o){o=d(o?o:f.obj.sheets());o.find("tr."+f.cl.barTopParent).remove();o.find("td."+f.cl.barLeft).remove();return o;},labelUpdate:function(p,o){if(!o){p=jSE.parseCellName(p.col,p.row);if(p){f.obj.label().text(p);}}else{f.obj.label().text(p);}},cellEdit:function(t,q){if(t.is(f.cellLast.td)){return;}f.autoFillerNotGroup=true;f.evt.cellEditDone();var r=f.getTdLocation(t);if(!f.spreadsheets[f.i]||!f.spreadsheets[f.i][r.row]||!f.spreadsheets[f.i][r.row][r.col]){return;}var o=f.spreadsheets[f.i][r.row][r.col],p;f.trigger("sheetCellEdit",[o]);f.followMe(t);f.labelUpdate(r);if(o.formula){p="="+o.formula;}else{p=o.value;}var s=f.obj.formula().val(p).blur();f.cellSetActive(t,r,q);},cellSetActive:function(v,u,r,p,t){if(u.col!=l){f.cellLast.td=v;f.cellLast.row=f.rowLast=u.row;f.cellLast.col=f.colLast=u.col;f.themeRoller.cell.setHighlighted(v);f.themeRoller.bar.setActive("left",u.row);f.themeRoller.bar.setActive("top",u.col);var o,s;switch(n.cellSelectModel){case"excel":case"gdrive":o=function(){};s=function(){};break;case"oo":o=function(w){if(f.isTd(w)){f.cellEdit(d(w));}};s=function(){};break;}if(r){var q={};q.last=u;f.obj.pane().mousemove(function(y){if(f.isBusy()){return false;}var x=f.getTdLocation(y.target),w=true;if(x.col<1||x.row<1){return false;}if(p){w=false;if(u.col==x.col||u.row==x.row){w=true;}}if((q.last.col!=x.col||q.last.row!=x.row)&&w){o(y.target);f.cycleCellArea(function(z){f.themeRoller.cell.setHighlighted(z.td);},u,x);}q.last=x;});c.one("mouseup",function(){f.obj.pane().unbind("mousemove").unbind("mouseup");if(t){t();}});}}},colLast:0,rowLast:0,cellLast:{td:d([]),row:0,col:0,isEdit:false},highlightedLast:{obj:d([]),rowStart:0,colStart:0,rowEnd:0,colEnd:0,barLeft:d([]),barTop:d([])},cellStyleToggle:function(u,v){f.setDirty(true);var s=f.highlighted(),q,o,t=s.length-1,w=f.obj.cellsEdited(),p=f.controls.cellsEdited[f.i],r;if(t>=0){r=d(s[0]).hasClass(u);do{q=s[t];o=d(q);if(v){o.removeClass(v);}else{if(r){o.removeClass(u);}else{o.addClass(u);}if(!q.jSCell.edited){q.jSCell.edited=true;p=w.add(q.jSCell);}}}while(t--);return true;}return false;},fontReSize:function(u){var q=0;switch(u){case"up":q=1;break;case"down":q=-1;break;}var s=f.highlighted(),r,o,t=s.length-1,w,v=f.obj.cellsEdited(),p=f.controls.cellsEdited[f.i];if(t>=0){do{r=s[t];o=d(r);w=(o.css("font-size")+"").replace("px","")*1;o.css("font-size",((w||10)+q)+"px");if(!r.jSCell.edited){r.jSCell.edited=true;p=v.add(r.jSCell);}}while(t--);return true;}return false;},callStack:0,updateCellValue:function(v,r,t){var q,w,u,s;if(!this.type||!this.type=="cell"){if(!(q=f.spreadsheets[v])){return n.error({error:f.msg.notFoundSheet});}if(!(w=q[r])){return n.error({error:f.msg.notFoundRow});}if(!(u=w[t])){return n.error({error:f.msg.notFoundColumn});}}else{u=this;v=this.sheet;r=this.row;t=this.col;}u.oldValue=u.value;if(u.result){delete u.result;}switch(u.state[u.state.length-1]){case"updating":return n.error({error:f.msg.loopDetected});case"updatingDependencies":return(u.valueOverride!=l?u.valueOverride:u.value);}if(u.defer){return this.updateCellValue.apply(u.defer);}u.state.push("updating");u.html=[];u.fnCount=0;u.result=null;if(u.calcLast!=f.calcLast||u.calcDependenciesLast!=f.calcDependenciesLast){u.valueOverride=null;u.calcLast=f.calcLast;u.calcDependenciesLast=f.calcDependenciesLast;u.needsUpdated=true;u.calcCount++;if(u.formula){try{if(u.formula.charAt(0)=="="){u.formula=u.formula.substring(1);}var o;if(f.callStack){if(!u.formulaParser){u.formulaParser=(new f.formulaParser);}o=u.formulaParser;}else{o=f.FormulaParser;}f.callStack++;o.lexer.obj=u;o.lexer.handler=f.cellHandler;u.result=o.parse(u.formula);}catch(p){u.result=p.toString();f.alertFormulaError(u.value);}f.callStack--;f.filterValue.apply(u);}else{if(u.value!=l&&u.value.charAt){s=f.s.cellStartingHandlers[u.value.charAt(0)];if(s){s.apply(u,[u.value]);}else{s=f.s.cellEndHandlers[u.value.charAt(u.value.length-1)];if(s){s.apply(u,[u.value]);}}}f.filterValue.apply(u);}}u.needsUpdated=false;u.state.pop();return(u.valueOverride!=l?u.valueOverride:u.value);},updateCellDependencies:function(){if((this.state||(this.state=[])).length){return;}this.state.push("updatingDependencies");var r=this.dependencies;this.dependencies={};for(var p in r){var o=r[p],q=f.getTdLocation(o.td);o.calcDependenciesLast=0;f.updateCellValue.apply(o);if(q.row>0&&q.col>0){f.updateCellDependencies.apply(o);}}this.state.pop();},filterValue:function(){var o=(this.html&&this.html.length?this.html.join(""):"");if(this.result!=l){this.value=this.result;this.td.html(o?this.html:n.encode(this.value));}else{if(o){this.td.html(this.html);}else{this.td.html(n.encode(this.value));}}},cellHandler:{variable:function(){if(arguments.length){var q=arguments[0],o=arguments[1],r=f.s.formulaVariables,p;switch(q.toLowerCase()){case"true":this.html.push("TRUE");return true;case"false":this.html.push("FALSE");return false;}if(p=r[q]&&!o){return p;}else{if(p&&o){return p[o];}else{return"";}}}},time:function(p,o){return times.fromString(p,o);},concatenate:function(){var o=f.getTdLocation(this.td);f.spreadsheets[this.sheet][o.row][o.col].html=[];jFN.CONCATENATE.apply(this,arguments);return this.value;},cellValue:function(q){var p=jSE.parseLocation(q),o;o=f.cellHandler.createDependency.apply(this,[this.sheet,p]);f.updateCellValue.apply(o);return(o.valueOverride!=l?o.valueOverride:o.value);},createDependency:function(p,s){var q,r,o;if(!(q=f.spreadsheets[p])){return;}if(!(r=q[s.row])){return;}if(!(o=r[s.col])){return;}if(!o.dependencies){o.dependencies={};}o.dependencies[p+"_"+s.row+"_"+s.col]=this;return o;},cellRangeValue:function(o,p){o=jSE.parseLocation(o);p=jSE.parseLocation(p);var w=[],r=g.max(o.row,p.row),v=g.min(o.row,p.row),q=g.max(o.col,p.col),s=q,t=g.min(o.col,p.col),u;if(r>=v||q>=t){do{q=s;do{u=f.spreadsheets[this.sheet][r][q];f.cellHandler.createDependency.apply(this,[this.sheet,{row:r,col:q}]);w.unshift(f.updateCellValue.apply(u));}while(q-->t);}while(r-->v);return w;}return w;},fixedCellValue:function(o){o=o.replace(/\$/g,"");return f.cellHandler.cellValue.apply(this,[o]);},fixedCellRangeValue:function(p,o){p=p.replace(/\$/g,"");o=o.replace(/\$/g,"");return f.cellHandler.cellRangeValue.apply(this,[p,o]);},remoteCellValue:function(o,q){var p=jSE.parseLocation(q);o=jSE.parseSheetLocation(o);f.cellHandler.createDependency.apply(this,[o,p]);return f.updateCellValue(o,p.row,p.col);},remoteCellRangeValue:function(s,t,p){s=jSE.parseSheetLocation(s);t=jSE.parseLocation(t);p=jSE.parseLocation(p);var o=[];for(var r=t.row;r<=p.row;r++){for(var q=t.col;q<=p.col;q++){o.push(f.updateCellValue(s,r,q));}}return[o];},callFunction:function(t,q){t=t.toUpperCase();q=q||[];if(d.sheet.fn[t]){this.fnCount++;var p=[],s=[],r=q.length;if(r){do{if(q[r]!=l){if(q[r].value||q[r].html){p.unshift(q[r].value);s.unshift(q[r].html);}else{p.unshift(q[r]);s.unshift(q[r]);}}}while(r--);}var o=d.sheet.fn[t].apply(this,p);if(o!=null){if(o.html!=l){this.html.push(o.html);}else{this.html.push(null);}if(o.value!=l){return o.value;}}return o;}else{return n.error({error:"Function "+t+" Not Found"});}}},cellLookupHandlers:{fixedCellValue:function(o){return[f.sheet,jSE.parseLocation(o),jSE.parseLocation(o)];},fixedCellRangeValue:function(p,q,o){return[jSE.parseSheetLocation(p),jSE.parseLocation(q),jSE.parseLocation(o)];},cellValue:function(o){},cellRangeValue:function(p,q,o){return[f.sheet,jSE.parseLocation(q),jSE.parseLocation(o)];},remoteCellValue:function(o,p){return[f.sheet,jSE.parseLocation(p),jSE.parseLocation(p)];},remoteCellRangeValue:function(p,q,o){return[jSE.parseSheetLocation(p),jSE.parseLocation(q),jSE.parseLocation(o)];},callFunction:function(){if(arguments[0]=="VLOOKUP"||arguments[0]=="HLOOKUP"&&arguments[1]){return arguments[1].reverse()[1];}}},cellLookup:function(){var o=(new f.formulaParser);o.lexer.obj=this.obj;o.lexer.handler=d.extend(o.lexer.handler,f.cellLookupHandlers);var q=o.parse(this.obj.formula),r=[];for(var s=q[1].row;s<=q[2].row;s++){for(var p=q[1].col;p<=q[2].col;p++){r.push({sheet:q[0],row:s,col:p});}}return r;},alertFormulaError:function(o){alert("cell:"+row+" ;"+col+"\n"+'value: "'+cell.formula+'"\n'+"error: \n"+e);},calcLast:0,calcDependenciesLast:0,calc:function(o){o=(o?o:f.i);if(f.readOnly[o]||f.isChanged()===false){return;}f.log("Calculation Started");f.calcLast=new Date();jSE.calc(o,f.spreadsheetsToArray()[o],f.updateCellValue);f.trigger("sheetCalculation",[{which:"speadsheet"}]);f.setChanged(false);f.log("Calculation Ended");},calcDependencies:function(p,o){p=p||new Date();f.calcDependenciesLast=p;if(!o){f.cellUndoable.add.apply(this,[p]);}f.trigger("sheetPreCalculation",[{which:"cell",cell:this}]);f.setDirty(true);f.setChanged(true);f.updateCellValue.apply(this);f.updateCellDependencies.apply(this);f.trigger("sheetCalculation",[{which:"cell",cell:this}]);if(!o){f.cellUndoable.add.apply(this,[p,true]);}},addSheet:function(o){if(!o){o=prompt(f.msg.newSheet);o=o.toLowerCase().split("x");o={cols:d.trim(o[0])*1,rows:d.trim(o[1])*1};}if(o){f.evt.cellEditAbandon();f.setDirty(true);var p=f.controlFactory.sheetUI(d.sheet.makeTable.fromSize(o),f.sheetCount);f.setActiveSheet(f.sheetCount-1);f.sheetSyncSize();f.obj.pane().trigger("resizeScroll");f.trigger("sheetAdd",[f.i]);}},deleteSheet:function(o){var p=o||f.i;f.obj.barHelper().remove();f.obj.enclosure().remove();f.obj.tabContainer().children().eq(f.i).remove();f.spreadsheets.splice(p,1);f.controls.autoFiller.splice(p,1);f.controls.bar.helper.splice(p,1);f.controls.bar.corner.splice(p,1);f.controls.bar.x.controls.splice(p,1);f.controls.bar.x.handleFreeze.splice(p,1);f.controls.bar.x.controls.splice(p,1);f.controls.bar.x.menu.splice(p,1);if(f.controls.bar.x.menuParent&&f.controls.bar.x.menuParent[p]){f.controls.bar.x.menuParent.splice(p,1);}f.controls.bar.x.parent.splice(p,1);f.controls.bar.x.scroll.splice(p,1);f.controls.bar.x.td.splice(p,1);f.controls.bar.y.controls.splice(p,1);f.controls.bar.y.handleFreeze.splice(p,1);f.controls.bar.y.controls.splice(p,1);f.controls.bar.y.menu.splice(p,1);if(f.controls.bar.y.menuParent&&f.controls.bar.y.menuParent[p]){f.controls.bar.y.menuParent.splice(p,1);}f.controls.bar.y.parent.splice(p,1);f.controls.bar.y.scroll.splice(p,1);f.controls.bar.y.td.splice(p,1);f.controls.barMenuLeft.splice(p,1);f.controls.barMenuTop.splice(p,1);f.controls.barLeft.splice(p,1);f.controls.barTop.splice(p,1);f.controls.barTopParent.splice(p,1);f.controls.chart.splice(p,1);f.controls.tdMenu.splice(p,1);f.controls.enclosure.splice(p,1);f.controls.fullScreen.splice(p,1);f.controls.inPlaceEdit.splice(p,1);f.controls.menuLeft.splice(p,1);f.controls.menuRight.splice(p,1);f.controls.pane.splice(p,1);f.controls.scroll.splice(p,1);f.controls.sheets.splice(p,1);f.controls.sheet.splice(p,1);f.controls.tab.splice(p,1);f.controls.toggleHide.x.splice(p,1);f.controls.toggleHide.y.splice(p,1);f.readOnly.splice(p,1);f.i=0;f.sheetCount--;f.sheetCount=g.max(f.sheetCount,0);if(f.sheetCount==0){f.addSheet({rows:25,cols:10});}f.setActiveSheet(f.i);f.setDirty(true);f.setChanged(true);f.trigger("sheetDelete",[p]);},deleteRow:function(p,o){p=p||f.rowLast;f.getTd(f.i,p,1).parent().remove();f.controls.bar.y.td[f.i].splice(p,1);f.spreadsheets[f.i].splice(p,1);f.refreshRowLabels(p);f.setChanged(true);f.offsetFormulas({row:p,col:0},{row:-1,col:0});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().trigger("resizeScroll");f.trigger("sheetDeleteRow",p);},deleteColumn:function(s,o){s=s||f.colLast;if(s<1){return;}f.obj.barHelper().remove();var r=f.obj.sheet(),q=f.col(r,s),u=f.obj.barTop(s).remove(),t=q.tds,p=t.length-1;do{d(t[p]).remove();}while(p--);f.obj.barTop(s).remove();f.controls.bar.x.td[f.i].splice(s,1);p=f.spreadsheets[f.i].length-1;do{f.spreadsheets[f.i][p].splice(s,1);}while(p-->1);d(q).remove();f.refreshColumnLabels(s);f.setChanged(true);f.offsetFormulas({row:0,col:s},{row:0,col:-1});f.setDirty(true);f.evt.cellEditAbandon();f.obj.pane().trigger("resizeScroll");f.trigger("sheetDeleteColumn",s);},sheetTab:function(p){var o="";if(p){o=f.obj.sheet().attr("title");o=(o?o:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1));}else{if(f.isSheetEditable()&&n.editableNames){var q=prompt(f.msg.newSheetTitle,f.sheetTab(true));if(!q){o=f.obj.sheet().attr("title");q=(o?o:f.msg.sheetTitleDefault.replace(/[{]index[}]/gi,f.i+1));}else{f.setDirty(true);f.obj.sheet().attr("title",q);f.obj.tab().html(q);o=q;}}}return d("<div />").text(o).html();},followMe:function(v,t){v=v||f.obj.tdActive();if(!v.length){return;}var J=f.obj.pane(),w=J.height(),P=J.width(),q=J.offset(),C={top:q.top,bottom:q.top+w,left:q.left,right:q.left+P},K=true,M=0,B=0,A=0,L=5,o=v.offset(),I=v.width(),F=v.height(),G={top:o.top,bottom:o.top+F,left:o.left,right:o.left+I},u=v.parent(),H=d(f.rowTds()[f.getTdLocation(v).col]),E,s=0,O=0,p={up:true,down:true,left:true,right:true},z=f.scrolledTo();if(F>w||I>P){return;}f.setBusy(true);while(K==true&&M<L){var r=f.getTd(f.i,z.row.end+A,z.col.end+B),D=H.is(":hidden"),N=u.is(":hidden");K=false;E={up:N,down:G.bottom-s>C.bottom,left:D,right:G.right-O>C.right};if(E.left){if(t){p.left=false;}else{B--;K=true;f.evt.scroll.scrollTo({axis:"x",value:z.col.end+B});}}else{if(E.right){if(t){p.right=false;}else{B++;K=true;}}}if(E.up){if(t){p.up=false;}else{A--;K=true;f.evt.scroll.scrollTo({axis:"y",value:z.row.end+A});}}else{if(E.down){if(t){p.down=false;}else{A++;K=true;}}}if(t){f.setBusy(false);return p;}s+=r.height();O+=r.width();M++;}if(B>0){f.evt.scroll.scrollTo({axis:"x",value:(z.col.end+1)+B});f.evt.scroll.stop();}if(A>0){f.evt.scroll.scrollTo({axis:"y",value:(z.row.end+1)+A});f.evt.scroll.stop();}setTimeout(function(){f.setBusy(false);},100);f.autoFillerGoToTd(v,F,I);},autoFillerGoToTd:function(r,p,q){if(!n.autoFiller){return;}r=r||f.obj.tdActive();p=p||r.height();q=q||r.width();if(f.isTd(r[0])&&r.is(":visible")){var o=r.position();f.obj.autoFiller().show().css("top",((o.top+(p||r.height())-3)+"px")).css("left",((o.left+(q||r.width())-3)+"px"));}else{f.autoFillerHide();}},autoFillerHide:function(){if(!n.autoFiller){return;}f.obj.autoFiller().hide();},setActiveSheet:function(o){o=o||0;if(f.cellLast.row>0||f.cellLast.col>0){f.evt.cellEditDone();f.obj.formula().val("");}f.obj.enclosures().hide();f.i=o;f.obj.enclosure().show();f.themeRoller.tab.setActive();f.readOnly[o]=f.obj.sheet().hasClass("readonly");f.obj.pane().trigger("resizeScroll");},openSheet:function(p){if(f.isDirty?confirm(f.msg.openSheet):true){f.setBusy(true);var r=f.controlFactory.header(),q=f.controlFactory.ui(),o=f.controlFactory.tabContainer();n.parent.append(r).append(q).append(o);p.each(function(s){f.controlFactory.sheetUI(d(this),s);f.calc(s);f.trigger("sheetOpened",[s]);});f.sheetSyncSize();f.setActiveSheet(0);f.setDirty(false);f.setBusy(false);f.trigger("sheetAllOpened");return true;}else{return false;}},newSheet:function(){var o=prompt(f.msg.newSheet);if(o){f.openSheet(d.sheet.makeTable.fromSize(o));}},importRow:function(p){f.controlFactory.addRow();var o="";f.obj.sheet().find("tr:last td").each(function(q){d(this).removeData("formula");try{if((p[q]+"").charAt(0)=="="){d(this).data("formula",p[q]);}else{d(this).html(p[q]);}}catch(r){o+=r+";\n";}});if(o){alert(o);}f.calc();},importColumn:function(o){f.controlFactory.addColumn();var p="";f.obj.sheet().find("tr").each(function(q){var s=d(this).find("td:last");try{if((o[q]+"").charAt(0)=="="){s.data("formula",o[q]);}else{s.html(o[q]);}}catch(r){p+=r+";\n";}});if(p){alert(p);}f.calc();},sheetSyncSize:function(){var p=n.height;if(!p){p=400;}else{if(p<200){p=200;}}n.parent.height(p).width(n.width);var o=n.width;p-=f.obj.header().outerHeight();p-=f.obj.tabContainer().outerHeight()+f.s.boxModelCorrection;f.obj.panes().height(p-window.scrollBarSize.height-n.boxModelCorrection).width(o-window.scrollBarSize.width);f.obj.enclosures().height(p).width(o);f.obj.scrolls().height(p).width(o);f.obj.ui().height(p).width(o);},cellChangeStyle:function(q,r){f.setDirty(this);var o=f.highlighted(true),p=o.length-1;if(p>=0){do{f.cellUndoable.add(o[p]);o[p].td.css(q,r);f.cellUndoable.add(o[p],true);}while(p--);return true;}return false;},cellFind:function(q){if(!q){q=prompt(f.msg.cellFind);}var p=f.obj.sheet().children("tbody").children("tr");if(q){var r=p.children('td:contains("'+q+'")');if(r.length<1){r=p.children('td:contains("'+q.toLowerCase()+'")');}if(r.length<1){r=p.children('td:contains("'+q.toUpperCase()+'")');}r=r.eq(0);if(r.length>0){f.cellEdit(r);}else{alert(f.msg.cellNoFind);}}},cellSetActiveBar:function(y,p,r){var D=f.sheetSize(),u=g.min(p,r),A=g.max(p,r),C={},z={},x={},t={},o=function(){switch(n.cellSelectModel){case"oo":f.cellEdit(f.getTd(f.i,t.end,x.end));break;default:f.cellEdit(f.getTd(f.i,t.start,x.start));break;}},s=d([]),v=f.scrolledTo(),w=f.obj.sheet();switch(y){case"top":C.start=1;C.end=D.rows;t.start=t.end=v.row.end;z.start=u;z.end=A;x.start=p;x.end=r;for(var q=z.start;q<=z.end;q++){s=s.add(f.col(w,q));}break;case"left":C.start=u;C.end=A;t.start=p;t.end=r;z.start=1;z.end=D.cols;x.start=x.end=v.col.end;for(var B=C.start;B<=C.end;B++){s=s.add(f.getTd(f.i,B,1)[0].parentNode);}break;case"corner":z.start=1;z.end=D.cols;C.start=1;C.end=D.rows;s=s.add(w);break;}o();f.themeRoller.cell.setHighlighted(s.add(f.obj.tdActive()));},getTdRange:function(r,x,u,w){f.cellLast.isEdit=true;var p=function(v){if(v.first.col>v.last.col||v.first.row>v.last.row){return{first:jSE.parseCellName(v.last.col,v.last.row),last:jSE.parseCellName(v.first.col,v.first.row)};}else{return{first:jSE.parseCellName(v.first.col,v.first.row),last:jSE.parseCellName(v.last.col,v.last.row)};}},t=function(B){var v=p(B),A=x+"";A=(A.match(/=/)?A:"="+A);if(u||A.charAt(A.length-1)!="("){A=A+(u?u:"")+"(";}var C,z="";if(v.first!=v.last){C=v.first+":"+v.last;}else{C=v.first;}if(A.charAt(A.length-1)=="("){z=")";}return A+C+z;},o="",q,s,y;if(r){q={first:f.getTdLocation([r.target])};s=f.obj.sheet().mousemove(function(v){q.last=f.getTdLocation([v.target]);o=t(q);if(!w){f.obj.formula().val(o);f.obj.inPlaceEdit().val(o);}});c.one("mouseup",function(){s.unbind("mousemove");return o;});}else{y=f.highlighted().not(f.obj.tdActive());if(y.length){var q={first:f.getTdLocation(y.first()),last:f.getTdLocation(y.last())};o=t(q);if(!w){f.obj.formula().val(o);f.obj.inPlaceEdit().val(o);}return o;}else{return"";}}},getTd:function(p,q,o){if(!f.spreadsheets[p]||!f.spreadsheets[p][q]||!f.spreadsheets[p][q][o]||!f.spreadsheets[p][q][o].td){return d("<td />");}return f.spreadsheets[p][q][o].td;},getTdLocation:function(p){var o={col:0,row:0};p=p||"";if(!p&&!p[0]){return o;}p=p[0]||p;if(p.cellIndex==l||p.parentNode==l||p.parentNode.rowIndex==l){return o;}return{col:parseInt(p.cellIndex),row:parseInt(p.parentNode.rowIndex)};},getTdFromXY:function(r,q,o){var t=f.obj.pane(),p=t.offset();q+=p.top;r+=p.left;if((q>=p.top&&q<=p.top+t.height())&&(r>=p.left&&r<=p.left+t.width())){var s=d.nearest({x:r,y:q},f.obj.sheet().children("tbody").children("tr").children("td"));if(f.isTd(s)){return s;}if(o&&f.isBar(s)){return s;}return false;}return false;},getBarIndex:{left:function(p){p=p||{};if(!p.parentNode||isNaN(p.parentNode.rowIndex)){return -1;}else{return p.parentNode.rowIndex;}},top:function(p){p=p||{};if(isNaN(p.cellIndex)){return -1;}else{return p.cellIndex;}},corner:function(){return 0;}},time:{now:new Date(),last:new Date(),diff:function(){return g.abs(g.ceil(this.last.getTime()-this.now.getTime())/1000).toFixed(5);},set:function(){this.last=this.now;this.now=new Date();},get:function(){return this.now.getHours()+":"+this.now.getMinutes()+":"+this.now.getSeconds();}},log:function(o){f.time.set();console.log(f.time.get()+", "+f.time.diff()+"; "+o);},changed:[],isChanged:function(){return f.changed[f.i];},setChanged:function(o){f.changed[f.i]=o;},isDirty:false,setDirty:function(o){f.dirty=o;},appendToFormula:function(o){var q=f.obj.formula(),p=q.val();if(p.charAt(0)!="="){p="="+p;}q.val(p+o);},cellUndoable:{stacks:[],undoOrRedo:function(p){if(!this.stacks[f.i]){return;}f.autoFillerHide();var o=this.stack(),q;if(p){o.moveBackward();}else{o.moveForward();}q=o.getCells();for(var r in q){var t=q[r].td,s=f.getTdLocation(t);f.spreadsheets[f.i][s.row][s.col]=q[r];t.data("formula",q[r].formula).attr("style",q[r].style).addClass(q[r].cl);f.cellLast.td=d([]);f.calcDependencies.apply(q[r],null,true);}},stack:function(){if(!this.stacks[f.i]){this.stacks[f.i]={i:0,max:20,lasts:[],lastsCells:[],getCells:function(p){var o=(p?d.inArray(p,this.lasts):this.i);if(o<0){this.i=this.lasts.length;this.lasts.push(p);o=this.lasts.length-1;this.lastsCells[o]=[];}return this.lastsCells[o];},cleanAhead:function(){this.lasts.splice(this.i+1,this.lasts.length-this.i);this.lastsCells.splice(this.i+1,this.lasts.length-this.i);},cleanBehind:function(){while(this.lasts.length>this.max){this.lasts.shift();this.lastsCells.shift();}},moveForward:function(){this.i+=1;this.i=g.min(this.i,this.lasts.length-1);},moveBackward:function(){this.i-=1;this.i=g.max(this.i,0);}};}return this.stacks[f.i];},add:function(u,r,w,p,o){var t=f.cellUndoable.stack(),v=t.getCells(u.valueOf()+(o?1:0));t.cleanAhead();if(w>0&p>0){var s={};for(var q in cell){s[q]=this[q];}s.style=this.td.attr("style");s.cl=(this.td.attr("class")||"").replace(f.cl.uiTdActive,"").replace(f.cl.uiTdHighlighted,"");s.sheet=this.sheet;}v.push(s);t.cleanBehind();}},cols:function(p){p=p||f.obj.sheet();if(!p[0]){return[];}if(!p[0].children){return[];}if(!p[0].children[0]){return[];}if(!p[0].children[0].children){return[];}return p[0].children[0].children;},tables:function(p){p=p||f.obj.sheets();p=p.clone();p.find("."+f.cl.barTopParent).remove();p.find("."+f.cl.barLeft).remove();p.children("colgroup").children("col:first").remove();p=f.sheetDecorateRemove(false,p);return p;},col:function(r,p){r=r||f.obj.sheet();var q=f.cols(r);if(p===l){p=q.length-1;}return q[p];},rowTds:function(r,q){r=r||f.obj.sheet();var p=f.rows(r);if(q==l){q=p.length-1;}if(!p[q]){return{};}if(!p[q].children){return{};}return p[q].children;},rows:function(p){p=p||f.obj.sheet();if(!p[0]){return{};}if(!p[0].children){return{};}if(!p[0].children[1]){return{};}if(!p[0].children[1].children){return{};}return p[0].children[1].children;},highlighted:function(p){var r=f.highlightedLast.obj||d([]),s=[],o,q;if(!(o=r)||!r.length||!(o=o[0])||!o.tagName){return s;}switch(o.tagName){case"TD":q=r.length-1;do{s.unshift(p?r[q].jSCell:r[q]);}while(q-->0);case"TR":q=r.length-1;do{if(r[q].tds){s=s.concat(p?r[q].jSCells:r[q].tds);}}while(q-->0);break;case"COL":r=r.filter("col");q=r.length-1;do{if(r[q].tds){s=s.concat(p?r[q].jSCells:r[q].tds);}}while(q-->0);break;case"TABLE":s=(p?o.jSCells:o.tds);break;}return p?s:d(s);},sheetSize:function(r){r=r||f.obj.sheet();var p=f.rowTds(r),q=f.getTdLocation(p[p.length-1]);return{cols:q.col,rows:q.row};},toggleState:function(o){if(n.allowToggleState){var p=o||f.tables().detach();if(n.editable){f.evt.cellEditAbandon();f.trigger("sheetSave",[p]);}f.setDirty(false);f.setChanged(true);n.editable=!n.editable;f.kill();n.parent.html(p).sheet(n);n=null;}},setCellRef:function(p){var r=f.obj.tdActive(),q=f.getTdLocation(r),o=(p?p:prompt(f.msg.setCellRef));if(o){f.s.formulaVariables[o]=f.updateCellValue(f.i,q.row,q.col);}}};f.setBusy(true);n.parent.data("sheetInstance",f);if(!window.console){window.console={log:function(){}};}if(!window.scrollBarSize){window.scrollBarSize=d.sheet.getScrollBarSize();}var a=d(window),h=document,c=d(h),b=d("body"),k=function(){},l=undefined,g=Math;f.formulaLexer=function(){};f.formulaLexer.prototype=formula.lexer;f.formulaParser=function(){this.lexer=new f.formulaLexer();this.yy={};};f.formulaParser.prototype=formula;f.FormulaParser=new f.formulaParser;n.origHtml=n.parent.children().detach();n.parent.addClass(f.cl.parent);n.parent.bind("sheetSwitch",function(q,p,o){f.switchSheet(o);}).bind("sheetRename",function(q,p,o){f.renameSheet(o);});n.width=(n.width?n.width:n.parent.width());n.height=(n.height?n.height:n.parent.height());if(!n.log){f.log=k;}if(!d.nearest){f.nearest=k;}f.resizableCells=f.resizableSheet=f.resizable;if(!d.ui){f.resizable=f.resizableCells=f.resizableSheet=f.draggable=k;}else{if(!n.resizableCells){f.resizableCells=k;}if(!n.resizableSheet){f.resizableSheet=k;}}if(!d.support.boxModel){n.boxModelCorrection=0;}if(!n.barMenus){f.controlFactory.barMenuTop=f.controlFactory.barMenuLeft=k;}if(!n.freezableCells){f.controlFactory.barHandleFreeze.top=f.controlFactory.barHandleFreeze.left=k;}if(n.calcOff){f.calc=k;}if(!window.Raphael){jSE.chart=k;}a.resize(function(){if(f&&!f.isBusy()){n.width=n.parent.width();n.height=n.parent.height();f.sheetSyncSize();}});if(d.sheet.fn){d.sheet.fn=d.extend(d.sheet.fn,n.formulaFunctions);if(d.sheet.advancedfn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.advancedfn);}if(d.sheet.financefn){d.sheet.fn=d.extend(d.sheet.fn,d.sheet.financefn);}}if(!n.alertFormulaErrors){f.alertFormulaError=k;}n.title=n.title||n.parent.attr("title")||"";f.s=n;if(n.origHtml.length){f.openSheet(n.origHtml);}f.setBusy(false);return f;},makeTable:{fromSize:function(c){c=c||{rows:25,cols:10};var f=jQuery("<table />"),h="<td></td>",d="";for(var b=c.cols;b>=1;b--){d+=h;}var g='<tr style="height: '+15+'px;">'+d+"</tr>",a="";for(var b=c.rows;b>=1;b--){a+=g;}return f.html("<tbody>"+a+"</tbody>");}},killAll:function(){if(jQuery.sheet){if(jQuery.sheet.instance){jQuery.sheet.instance.each(function(){if(this.kill){this.kill();}});jQuery.sheet.instance=$([]);}}},scrollLocker:function(a){jQuery.sheet.instance[a].obj.scrolls().each(function(b){var c=this;$(this).bind("scroll",function(){jQuery.sheet.instance.each(function(d){if(d!=a){this.controls.scroll[b].scrollLeft(c.scrollLeft).scrollTop(c.scrollTop);}});});});},switchSheetLocker:function(a){jQuery.sheet.instance.each(function(){this.s.parent.bind("switch",function(d,c,b){jQuery.sheet.instance.each(function(){this.setActiveSheet(b);});});});},I:function(){var a=0;if(this.instance){a=(this.instance.length===0?0:this.instance.length-1);}else{this.instance=[];}return a;},getScrollBarSize:function(){var d=$("<p></p>").css({width:"100%",height:"100%"}),j=$("<div></div>").css({position:"absolute",width:"100px",height:"100px",top:"0",left:"0",visibility:"hidden",overflow:"hidden"}).append(d);jQuery(document.body).append(j);var c=d.width(),g=d.height();j.css("overflow","scroll");var a=d.width(),f=d.height();if(c==a&&j[0].clientWidth){a=j[0].clientWidth;}if(g==f&&j[0].clientHeight){f=j[0].clientHeight;}j.detach();var b=c-a,k=g-f;return{width:b||15,height:k||15};},debugPositionBox:function(a,g,c,b,f){b=b||"#"+Math.floor(Math.random()*16777215).toString(16);if(c){var d=jQuery([]);d=d.add(this.debugPositionBox(c.left,c.top,null,b,"top-left"));d=d.add(this.debugPositionBox(c.right,c.top,null,b,"top-right"));d=d.add(this.debugPositionBox(c.left,c.bottom,null,b,"bottom-left"));d=d.add(this.debugPositionBox(c.right,c.bottom,null,b,"bottom-right"));return d;}return jQuery('<div style="width: 10px; height: 10px; position: absolute;"></div>').css("top",(g-5)+"px").css("left",(a+5)+"px").css("background-color",b).click(function(){console.log(f||"none");}).appendTo("body");}};var jSE=jQuery.sheet.engine={calc:function(c,a,d){a=a||[];var f=a.length-1,b;if(f>0){do{if(f>0){b=a[f].length-1;if(b>0){do{d(c,f,b);}while(b--);}}}while(f--);}},parseLocation:function(b){for(var a=0;a<b.length;a++){if(b.charCodeAt(a)<=57){break;}}return{row:parseInt(b.substring(a)),col:jSE.columnLabelIndex(b.substring(0,a))};},parseSheetLocation:function(a){return((a+"").replace("SHEET","")*1)-1;},parseCellName:function(a,b){return jSE.columnLabelString(a)+(b||"");},alphabet:"ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),columnLabels:{},columnLabelIndex:function(a){return this.columnLabels[a.toUpperCase()];},columnIndexes:[],columnLabelString:function(d){if(!this.columnIndexes.length){var g="",f,c,b,a;f=c=b=-1;for(a=1;a<16385;++a){g="";++b;if(b==26){b=0;++c;if(c==26){c=0;++f;}}if(f>=0){g+=this.alphabet[f];}if(c>=0){g+=this.alphabet[c];}if(b>=0){g+=this.alphabet[b];}this.columnIndexes[a]=g;this.columnLabels[g]=a;}}return this.columnIndexes[d]||"";},regEx:{n:/[\$,\s]/g,cell:/\$?([a-zA-Z]+|[#]REF[!])\$?([0-9]+|[#]REF[!])/gi,range:/\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCell:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+)/gi,remoteCellRange:/\$?(SHEET+)\$?([0-9]+)[:!]\$?([a-zA-Z]+)\$?([0-9]+):\$?([a-zA-Z]+)\$?([0-9]+)/gi,sheet:/SHEET/i,amp:/&/g,gt:/</g,lt:/>/g,nbsp:/&nbsp;/g},chart:function(d){var c=this.jS,a=this;function b(f,g){if(!f){if(g){f=0;}else{f="";}}else{if(g){f=arrHelpers.toNumbers(f);}else{f=arrHelpers.flatten(f);}}return f;}d=jQuery.extend({x:{legend:"",data:[0]},y:{legend:"",data:[0]},title:"",data:[0],legend:"",td:this.td,chart:jQuery('<div class="'+c.cl.chart+'" />').mousedown(function(){d.td.mousedown();}),gR:{}},d);c.controls.chart[c.i]=c.obj.chart().add(d.chart);d.data=b(d.data,true);d.x.data=b(d.x.data,true);d.y.data=b(d.y.data,true);d.legend=b(d.legend);d.x.legend=b(d.x.legend);d.y.legend=b(d.y.legend);d.legend=(d.legend?d.legend:d.data);c.s.parent.one("sheetCalculation",function(){var g=d.chart.width(),f=d.chart.height(),h=Raphael(d.chart[0]);if(d.title){h.text(g/2,10,d.title).attr({"font-size":20});}switch(d.type){case"bar":d.gR=h.barchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this);},function(){this.flag.animate({opacity:0},300,function(){this.remove();});});break;case"hbar":d.gR=h.hbarchart(g/8,f/8,g*0.8,f*0.8,d.data,d.legend).hover(function(){this.flag=h.popup(this.bar.x,this.bar.y,this.bar.value||"0").insertBefore(this);},function(){this.flag.animate({opacity:0},300,function(){this.remove();});});break;case"line":d.gR=h.linechart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,{nostroke:false,axis:"0 0 1 1",symbol:"circle",smooth:true}).hoverColumn(function(){this.tags=h.set();if(this.symbols.length){for(var j=0,k=this.y.length;j<k;j++){this.tags.push(h.tag(this.x,this.y[j],this.values[j],160,10).insertBefore(this).attr([{fill:"#fff"},{fill:this.symbols[j].attr("fill")}]));}}},function(){this.tags&&this.tags.remove();});break;case"pie":d.gR=h.piechart(g/2,f/2,(g<f?g:f)/2,d.data,{legend:d.legend}).hover(function(){this.sector.stop();this.sector.scale(1.1,1.1,this.cx,this.cy);if(this.label){this.label[0].stop();this.label[0].attr({r:7.5});this.label[1].attr({"font-weight":800});}},function(){this.sector.animate({transform:"s1 1 "+this.cx+" "+this.cy},500,"bounce");if(this.label){this.label[0].animate({r:5},500,"bounce");this.label[1].attr({"font-weight":400});}});break;case"dot":d.gR=h.dotchart(g/8,f/8,g*0.8,f*0.8,d.x.data,d.y.data,d.data,{symbol:"o",max:10,heat:true,axis:"0 0 1 1",axisxstep:d.x.data.length-1,axisystep:d.y.data.length-1,axisxlabels:(d.x.legend?d.x.legend:d.x.data),axisylabels:(d.y.legend?d.y.legend:d.y.data),axisxtype:" ",axisytype:" "}).hover(function(){this.marker=this.marker||h.tag(this.x,this.y,this.value,0,this.r+2).insertBefore(this);this.marker.show();},function(){this.marker&&this.marker.hide();});break;}d.gR.mousedown(function(){d.td.mousedown().mouseup();});d.chart.mousemove(function(){d.td.mousemove();return false;});});return d.chart;}};var jFN=jQuery.sheet.fn={ISNUMBER:function(a){if(!isNaN(a)){return{value:true,html:"TRUE"};}return{value:false,html:"FALSE"};},N:function(a){if(a==null){return 0;}if(a instanceof Date){return a.getTime();}if(typeof(a)=="object"){a=a.toString();}if(typeof(a)=="string"){a=parseFloat(a.replace(jSE.regEx.n,""));}if(isNaN(a)){return 0;}if(typeof(a)=="number"){return a;}if(a==true){return 1;}return 0;},VERSION:function(){return this.jS.version;},ABS:function(a){return Math.abs(jFN.N(a));},CEILING:function(b,a){a=a||1;return(parseInt(b/a)*a)+a;},EVEN:function(a){a=Math.round(a);var b=(a%2==0);if(!b){if(a>0){a++;}else{a--;}}return a;},EXP:function(a){return Math.exp(a);},FLOOR:function(b,a){a=a||1;if((b<0&&a>0)||(b>0&&a<0)){return{value:0,html:"#NUM"};}if(b>=0){return Math.floor(b/a)*a;}else{return Math.ceil(b/a)*a;}},INT:function(a){return Math.floor(jFN.N(a));},LN:function(a){return Math.log(a);},LOG:function(a,b){b=b||10;return Math.log(a)/Math.log(b);},LOG10:function(a){return jFN.LOG(a);},MOD:function(a,c){var b=a%c;if(c<0){b*=-1;}return b;},ODD:function(a){var c=false;if(a>0){a=Math.floor(Math.round(a));c=true;}else{a=Math.ceil(a);}var b=Math.abs(a);if((b%2)==0){b++;}if(c){return b;}else{return -b;}},PI:function(){return Math.PI;},POWER:function(a,b){return Math.pow(a,b);},SQRT:function(a){return Math.sqrt(a);},RAND:function(){return Math.random();},RND:function(){return Math.random();},ROUND:function(c,b){var a=Math.pow(10,b||0);return Math.round(c*a)/a;},ROUNDDOWN:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.floor(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b);},ROUNDUP:function(b,a){var c=(b<0);b=Math.abs(b);a=a||0;b=Math.ceil(b*Math.pow(10,a))/Math.pow(10,a);return(c?-b:b);},SUM:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){b+=a[i]*1;}return b;},TRUNC:function(a,b){b=b||0;a=a+"";if(b==0){return a.split(".").shift();}if(a.match(".")){if(b==1){a=a.substr(0,a.length-1);}else{if(b==-1){a=a.split(".").shift();a=a.substr(0,a.length-1)+"0";}}}return a;},AVERAGE:function(a){return jFN.SUM(arguments)/jFN.COUNT(arguments);},AVG:function(a){return jFN.AVERAGE(a);},COUNT:function(){var b=0,a=arrHelpers.toNumbers(arguments);for(i in a){if(a[i]!=null){b++;}}return b;},COUNTA:function(){var b=0,a=arrHelpers.flatten(arguments);for(i in a){if(a[i]){b++;}}return b;},MAX:function(){var b=arrHelpers.toNumbers(arguments),a=b[0];for(i in b){a=(b[i]>a?b[i]:a);}return a;},MIN:function(){var a=arrHelpers.toNumbers(arguments),b=a[0];for(i in a){b=(a[i]<b?a[i]:b);}return b;},ASC:function(a){return a.charCodeAt(0);},CHAR:function(a){return String.fromCharCode(a);},CLEAN:function(a){var b=new RegExp("[cG\x1BcLcJcMcIcK\x07\x1B\f\n\r\t\v]","g");return a.replace(b,"");},CODE:function(a){return jFN.ASC(a);},CONCATENATE:function(){var b=arrHelpers.flatten(arguments),a="";jQuery.each(b,function(c){a+=b[c];});return{value:a,html:a};},DOLLAR:function(b,a,f){a=a||2;f=f||"$";var d=jFN.FIXED(b,a,false).value,c;if(b>=0){c=f+d;}else{c="-"+f+d.slice(1);}return{value:b,html:c};},FIXED:function(c,b,a){b=(b===undefined?2:b);var f=Math.pow(10,b);c=Math.round(c*f)/f;var d=Globalize.format(c,"n"+b);return{value:c.toFixed(b),html:(a?d.replace(Globalize.culture().numberFormat[","],""):d)};},LEFT:function(a,b){b=b||1;return a.substring(0,b);},LEN:function(a){if(!a){return 0;}return a.length;},LOWER:function(a){return a.toLowerCase();},MID:function(b,c,a){if(!b||!c||!a){return this.jS.s.error({error:"ERROR"});}return b.substring(c-1,a+c-1);},REPLACE:function(b,f,c,d){if(!b||!f||!c||!d){return this.jS.s.error({error:"ERROR"});}var a=b.split("");a.splice(f-1,c);a.splice(f-1,0,d);return a.join("");},REPT:function(b,d){var a="";for(var c=0;c<d;c++){a+=b;}return a;},RIGHT:function(a,b){b=b||1;return a.substring(a.length-b,a.length);},SEARCH:function(c,a,d){d=d||0;if(d){a=a.split("");a.splice(0,d-1);a=a.join("");}var b=a.search(c);if(b<0){return this.jS.s.error({error:"#VALUE!"});}return d+(d?0:1)+b;},SUBSTITUTE:function(d,a,c,f){f=f||0;a=new RegExp(a,"g");var b=1;d=d.replace(a,function(h,k,l,j){var g=h;if(f){if(b>=f){g=c;}}else{g=c;}b++;return g;});return d;},TEXT:function(){return this.jS.s.error({error:"Not Yet Implemented"});},UPPER:function(a){return a.toUpperCase();},VALUE:function(a){if(jQuery.isNumeric(a)){return a*=1;}else{return this.jS.s.error({error:"#VALUE!"});}},NOW:function(){var a=new Date();return{value:a,html:dates.toString(a)};},TODAY:function(){var a=new Date();return{value:dates.toCentury(a)-1,html:dates.toString(a,"d")};},WEEKENDING:function(b){var a=new Date();a=new Date(a.getFullYear(),a.getMonth(),a.getDate()+5-a.getDay()-((b||0)*7));return{value:a,html:dates.toString(a,"d")};},WEEKDAY:function(b,c){b=dates.get(b);var a=b.getDay();c=(c?c:1);switch(c){case 3:switch(a){case 0:return 7;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;}break;case 2:switch(a){case 0:return 6;case 1:return 0;case 2:return 1;case 3:return 2;case 4:return 3;case 5:return 4;case 6:return 5;}break;case 1:a++;break;}return a;},WEEKNUM:function(a){a=dates.get(a);return dates.week(a)+1;},YEAR:function(a){a=dates.get(a);return a.getFullYear();},DAYSFROM:function(b,c,a){return Math.floor((new Date()-new Date(b,(c-1),a))/dates.dayDiv);},DAYS:function(f,c){var b=dates.get(f),a=dates.get(c),d=1000*60*60*24;return Math.round(Math.abs(b.getTime()-a.getTime())/d);},DAY:function(a){a=dates.get(a);return a.getDate();},DAYS360:function(g,c,j){g=dates.get(g);c=dates.get(c);var a=g.getDate(),f=c.getDate(),d=dates.isLastDayOfMonth(g),h=dates.isLastDayOfMonth(c),b=dates.diffMonths(g,c);if(j){a=Math.min(a,30);f=Math.min(f,30);}else{if(d){a=30;}if(h){if(a<30){b++;f=1;}else{f=30;}}}return(b*30)+(f-a);},DATE:function(c,d,a){var b=new Date(c,d-1,a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)};},DATEVALUE:function(a){a=dates.get(a);return{html:dates.toString(a,"d"),value:dates.toCentury(a)};},EDATE:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a);return{html:dates.toString(b,"d"),value:dates.toCentury(b)};},EOMONTH:function(b,a){b=dates.get(b),b.setMonth(b.getMonth()+a+1);b=new Date(b.getFullYear(),b.getMonth(),0);return{html:dates.toString(b,"d"),value:dates.toCentury(b)};},HOUR:function(a){a=times.fromMath(a);return a.hour;},MINUTE:function(a){return times.fromMath(a).minute;},MONTH:function(a){a=dates.get(a);return a.getMonth()+1;},SECOND:function(a){return times.fromMath(a).second;},TIME:function(a,h,c){var b=new Date();c=(c?c:0),h=(h?h:0),a=(a?a:0);if(c&&c>60){var d=(((c/60)+"").split(".")[0])*1;c=c-(d*60);h+=d;}if(h&&h>60){var g=(((h/60)+"").split(".")[0])*1;h=h-(g*60);a+=g;}var f=(a*60*60*1000)+(h*60*1000)+(c*1000);return f/dates.dayDiv;},TIMEVALUE:function(a){if(!isNaN(a)){return a;}if(/([0]?[1-9]|1[0-2])[:][0-5][0-9]([:][0-5][0-9])?[ ]?(AM|am|aM|Am|PM|pm|pM|Pm)/.test(a)){return times.fromString(a,true);}else{if(/([0]?[0-9]|1[0-9]|2[0-3])[:][0-5][0-9]([:][0-5][0-9])?/.test(a)){return times.fromString(a);}}return 0;},WORKDAY:function(a,j,g){var d={1:true,2:true,3:true,4:true,5:true},a=dates.get(a),j=(j&&!isNaN(j)?j:0),c=0,b=0,h=new Date();h=a;if(g){if(!jQuery.isArray(g)){g=[g];}g=arrHelpers.flatten(g);var f={};jQuery.each(g,function(k){if(g[k]){f[dates.toString(dates.get(g[k]),"d")]=true;}});g=f;}else{g={};}while(b<j){h=new Date(h.setDate(h.getDate()+1));if(d[h.getDay()]){if(!g[dates.toString(h,"d")]){b++;}}c++;}return{html:dates.toString(h,"d"),value:dates.toCentury(h)};},YEARFRAC:function(a,f,d){a=dates.get(a);f=dates.get(f);if(!a||!f){return this.jS.s.error({error:"#VALUE!"});}d=(d?d:0);var c=dates.diff(a,f,d),b=dates.calcAnnualBasis(a,f,d);return c/b;},AND:function(){var b=arguments,c,a=this;jQuery.each(b,function(d){a.html.pop();if(b[d]!==true&&c==undefined){c=jFN.FALSE();}});if(!c){c=jFN.TRUE();}return c;},FALSE:function(){return{value:false,html:"FALSE"};},IF:function(j,g,d){var h,f,b=this.html.pop(),a=this.html.pop(),c=this.html.pop();if(j.condition!=undefined){if(j.condition){h=g;f=a;this.html.pop();}else{h=d;f=b;}}else{if(j){h=g;f=a;this.html.pop();}else{h=d;f=b;}}return{value:h,html:f};},NOT:function(b){var a=new String(b);this.html.pop();if(!b){a.condition=true;return{value:a,html:"TRUE"};}a.condition=false;return{value:a,html:"FALSE"};},OR:function(){var a=false;for(var b in arguments){this.html.pop();if((arguments[b]==true||arguments[b]==1)&&!a){a=true;}}if(a){return{value:true,html:"TRUE"};}return{value:false,html:"FALSE"};},TRUE:function(){return{value:true,html:"TRUE"};},GREATER:function(c,b){var a;this.html.pop();this.html.pop();if(c>b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"};}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"};}},LESS:function(c,b){var a;this.html.pop();this.html.pop();if(c<b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"};}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"};}},EQUAL:function(c,b){var a;this.html.pop();this.html.pop();c=(c.condition!=undefined?c.condition:c);b=(b.condition!=undefined?b.condition:b);if(c==b){return{value:true,html:"TRUE"};}else{return{value:false,html:"FALSE"};}},GREATER_EQUAL:function(c,b){var a;this.html.pop();this.html.pop();if(c>=b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"};}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"};}},LESS_EQUAL:function(c,b){var a;this.html.pop();this.html.pop();if(c<=b){a=new String(c);a.condition=true;return{value:a,html:"TRUE"};}else{a=new String(b);a.condition=false;return{value:a,html:"FALSE"};}},IMG:function(a){return{html:jQuery("<img />").attr("src",a)};},GETHTML:function(){return this.html[0];},TRIM:function(a){if(typeof(a)=="string"){a=jQuery.trim(a);}return a;},HYPERLINK:function(b,a){a=(a?a:"LINK");return{html:jQuery('<a href="'+b+'" target="_new">'+a+"</a>")};},DROPDOWN:function(){var a=this,f=this.jS,b=arrHelpers.flatten(arguments),d=this.td.children().detach(),g=f.getTdLocation(a.td);b=arrHelpers.unique(b);if(!d.length||a.needsUpdated){var h="dropdown"+this.sheet+"_"+g.row+"_"+g.col+"_"+f.I;d=jQuery('<select name="'+h+'" id="'+h+'" class="jSDropdown" />').mousedown(function(){f.cellEdit(jQuery(this).parent(),null,true);}).change(function(){a.value=d.val();f.calcDependencies.apply(a,[a.calcDependenciesLast]);});d[0].cell=a;f.controls.inputs[f.i]=f.obj.inputs().add(d);for(var c=0;c<(b.length<=50?b.length:50);c++){if(b[c]){d.append('<option value="'+b[c]+'">'+b[c]+"</option>");}}if(!f.s.editable){d.attr("disabled",true);}d.val(a.value).change();}return{value:a.value,html:d};},RADIO:function(){var a=this,g=this.jS,c=arrHelpers.flatten(arguments),f=this.td.children().detach(),h=g.getTdLocation(a.td);c=arrHelpers.unique(c);if(!f.length||a.needsUpdated){var j="radio"+this.sheet+"_"+h.row+"_"+h.col+"_"+g.I;f=jQuery('<span class="jSRadio"/>').mousedown(function(){g.cellEdit(jQuery(this).parent());});f[0].cell=a;g.controls.inputs[g.i]=g.obj.inputs().add(f);for(var d=0;d<(c.length<=25?c.length:25);d++){if(c[d]){var b=jQuery('<input type="radio" name="'+j+'" class="'+j+'" />').val(c[d]).change(function(){a.value=jQuery(this).val();g.calcDependencies.apply(a,[a.calcDependenciesLast]);});if(c[d]==a.value){b.attr("checked","true");b.change();}f.append(b).append(jQuery("<span>"+c[d]+"</span>").click(function(){$(this).prev().click();})).append("<br />");}}if(!g.s.editable){f.find("input").attr("disabled",true);}}return{value:a.value,html:f};},CHECKBOX:function(b){if(jQuery.isArray(b)){b=b[0];}var a=this,f=this.jS,c=this.td.children().detach(),g=f.getTdLocation(a.td),d=$([]);if((!c.length||a.needsUpdated)){var h="checkbox"+this.sheet+"_"+g.row+"_"+g.col+"_"+f.I;d=jQuery('<input type="checkbox" name="'+h+'" class="'+h+'" />').val(b).change(function(){if(d.is(":checked")){a.value=b;}else{a.value="";}f.calcDependencies.apply(a,[a.calcDependenciesLast]);});if(!f.s.editable){d.attr("disabled",true);}c=jQuery('<span class="jSCheckbox"/>').append(d).append("<span>"+b+"</span><br />").mousedown(function(){f.cellEdit(jQuery(this).parent());});c[0].cell=a;f.controls.inputs[f.i]=f.obj.inputs().add(c);if(b==a.value){d.attr("checked",true);d.change();}}return{value:a.value=="true"||d.is(":checked")?b:"",html:c};},BARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"bar",data:a,legend:b,title:c}])};},HBARCHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"hbar",data:a,legend:b,title:c}])};},LINECHART:function(b,a){return{value:"",html:jSE.chart.apply(this,[{type:"line",x:{data:b},y:{data:a},title:""}])};},PIECHART:function(a,b,c){return{value:"",html:jSE.chart.apply(this,[{type:"pie",data:a,legend:b,title:c}])};},DOTCHART:function(g,d,a,c,b,f){return{value:"",html:jSE.chart.apply(this,[{type:"dot",data:(a?a:g),x:{data:g,legend:c},y:{data:(d?d:g),legend:(b?b:c)},title:f}])};},CELLREF:function(a){return(this.jS.spreadsheets[a]?this.jS.spreadsheets[a]:"Cell Reference Not Found");},CALCTIME:function(){var a=this;this.s.parent.one("sheetCalculation",function(){a.jS.getTd(a.sheet,a.row,a.col).text(a.jS.time.diff());});return"";},HLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,d-1,c[b].col);}}return a;},VLOOKUP:function(g,f,d,a){var c=this.jS.cellLookup.apply(this);for(var b=0;b<f[0].length;b++){if(f[0][b]==g){return this.jS.updateCellValue(c[b].sheet,c[b].row,d);}}return a;},THISROWCELL:function(a){var b=this.jS,c=b.getTdLocation(this.td);if(isNaN(a)){a=jSE.columnLabelIndex(a);}return b.updateCellValue(this.sheet,c.row,a);},THISCOLCELL:function(c){var a=this.jS,b=a.getTdLocation(this.td);return a.updateCellValue(this.sheet,c,b.col);}};var key={BACKSPACE:8,CAPS_LOCK:20,COMMA:188,CONTROL:17,ALT:18,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,INSERT:45,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SHIFT:16,SPACE:32,TAB:9,UP:38,C:67,F:70,V:86,X:88,Y:89,Z:90};var arrHelpers={math:Math,toNumbers:function(a){a=this.flatten(a);for(i in a){if(a[i]){a[i]=jQuery.trim(a[i]);if(isNaN(a[i])){a[i]=0;}else{a[i]=a[i]*1;}}else{a[i]=0;}}return a;},unique:function(b){var d=[],c=b.length;for(var g=0;g<c;g++){for(var f=g+1;f<c;f++){if(b[g]===b[f]){f=++g;}}d.push(b[g]);}return d;},flatten:function(a){var f=[];for(var c=0,b=a.length;c<b;c++){var d=Object.prototype.toString.call(a[c]).split(" ").pop().split("]").shift().toLowerCase();if(d){f=f.concat(/^(array|collection|arguments|object)$/.test(d)?this.flatten(a[c]):a[c]);}}return f;},insertAt:function(a,c,b){jQuery(c).each(function(){if(b>-1&&b<=a.length){a.splice(b,0,this);}});return a;},closest:function(h,a,c){h=h||[];a=a||0;c=c||0;var f=h[c],g=this.math.abs(a-f);var b=h.length-1;if(b){do{var d=this.math.abs(a-h[b]);if(d<g){g=d;f=h[b];}}while(b--);}return f;}};var dates={math:Math,dayDiv:86400000,toCentury:function(a){return this.math.round(this.math.abs((new Date(1900,0,-1))-a)/this.dayDiv);},get:function(b){if(b.getMonth){return b;}else{if(isNaN(b)){return new Date(Globalize.parseDate(b));}else{b*=this.dayDiv;var a=(new Date(1900,0,-1))*1;b+=a;b=new Date(b);return b;}}},week:function(a){var b=new Date(a.getFullYear(),0,1);return this.math.ceil((((a-b)/this.dayDiv)+b.getDay()+1)/7);},toString:function(a,b){if(!b){return Globalize.format(a);}return Globalize.format(a,Globalize.culture().calendar.patterns[b]);},diff:function(d,b,c){switch(c){case 0:return this.days360Nasd(d,b,0,true);case 1:case 2:case 3:var a=this.math.abs(b-d)/this.dayDiv;return a;case 4:return this.days360Euro(d,b);}},diffMonths:function(c,b){var a;a=(b.getFullYear()-c.getFullYear())*12;a-=c.getMonth()+1;a+=b.getMonth()+1;return a;},days360:function(c,g,d,b,a,f){return((g-c)*360)+((b-d)*30)+(f-a);},days360Nasd:function(b,f,a,c){var d=b.getDate(),k=b.getMonth(),j=b.getFullYear(),h=f.getDate(),g=f.getMonth(),l=f.getFullYear();if((g==2&&this.isEndOfMonth(h,g,l))&&((k==2&&this.isEndOfMonth(d,k,j))||a==3)){h=30;}if(h==31&&(d>=30||a==3)){h=30;}if(d==31){d=30;}if(c&&k==2&&this.isEndOfMonth(d,k,j)){d=30;}return this.days360(j,l,k,g,d,h);},days360Euro:function(j,c){var a=j.getDate(),f=j.getMonth(),d=j.getFullYear(),g=c.getDate(),b=c.getMonth(),h=c.getFullYear();if(a==31){a=30;}if(g==31){g=30;}return this.days360(d,h,f,b,a,g);},isEndOfMonth:function(a,c,b){return a==(new Date(b,c+1,0,23,59,59)).getDate();},isLeapYear:function(a){return new Date(a,1,29).getMonth()==1;},calcAnnualBasis:function(a,c,h){switch(h){case 0:case 2:case 4:return 360;case 3:return 365;case 1:var b=a.getDate(),k=a.getMonth(),g=a.getFullYear(),d=c.getDate(),f=c.getMonth(),l=c.getFullYear(),m;if(g==l){if(this.isLeapYear(g)){m=366;}else{m=365;}}else{if(((l-1)==g)&&((k>f)||((k==f)&&b>=d))){if(this.isLeapYear(g)){if(k<2||(k==2&&b<=29)){m=366;}else{m=365;}}else{if(this.isLeapYear(l)){if(f>2||(f==2&&d==29)){m=366;}else{m=365;}}else{m=365;}}}else{for(var j=g;j<=l;j++){if(this.isLeapYear(j)){m+=366;}else{m+=365;}}m=m/(l-g+1);}}return m;}},lastDayOfMonth:function(a){a.setDate(0);return a.getDate();},isLastDayOfMonth:function(a){return(a.getDate()==this.lastDayOfMonth(a));}};var times={math:Math,fromMath:function(c){var a={},b=this;a.hour=((c*24)+"").split(".")[0]*1;a.minute=function(d){d=b.math.round(d*24*100)/100;d=(d+"").split(".");var f=0;if(d[1]){if(d[1].length<2){d[1]+="0";}f=d[1]*0.6;}return b.math.round(f);}(c);a.second=function(h){h=b.math.round(h*24*10000)/10000;h=(h+"").split(".");var f=0;if(h[1]){for(var g=0;g<4;g++){if(!h[1].charAt(g)){h[1]+="0";}}var d=((h[1]*0.006)+"").split(".");if(d[1]){if(d[1]&&d[1].length>2){d[1]=d[1].substr(0,2);}return b.math.round(d[1]*0.6);}}return f;}(c);return a;},fromString:function(c,j){var d=new Date(),h=c,a,g,f,b,k;if(j){k=h.substr(-2).toLowerCase();h=h.replace(/(am|pm)/i,"");}h=h.split(":");g=h[0]*1;f=h[1]*1;b=(h[2]?h[2]:0)*1;if(j&&k=="pm"){g+=12;}return jFN.TIME(g,f,b);}};var math={log10:function(a){return Math.log(a)/2.302585092994046;},signum:function(a){return(a/Math.abs(a))||a;},log1p:function(a){var b=0,d=50;if(a<=-1){return"-INF";}if(a<0||a>1){return Math.log(1+a);}for(var c=1;c<d;c++){if((c%2)===0){b-=Math.pow(a,c)/c;}else{b+=Math.pow(a,c)/c;}}return b;}};jQuery.print=function(b){var a=window.open();a.document.write("<html><body><xmp>"+b+"\n</xmp></body></html>");a.document.close();};